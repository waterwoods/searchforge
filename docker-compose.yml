version: "3.9"
services:
  base:
    build:
      context: .
      dockerfile: docker/base/Dockerfile
    image: searchforge-base:py310
  qdrant:
    image: qdrant/qdrant:v1.15.0
    restart: unless-stopped
    ports: [ "6333:6333" ]
    volumes: [ "qdrant_data:/qdrant/storage" ]
  rag-api:
    build:
      context: .
      dockerfile: services/rag_api/Dockerfile
    restart: unless-stopped
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - SENTENCE_TRANSFORMERS_HOME=/app/models
      - HF_HOME=/app/models
      - TRANSFORMERS_CACHE=/app/models
      - RAG_API_SLA_SAMPLING=${RAG_API_SLA_SAMPLING:-on}
      - SLA_WINDOW_SEC=${SLA_WINDOW_SEC:-120}
    ports: [ "8000:8000" ]
    depends_on: [ qdrant ]
    volumes:
      - ~/ssx-lab/models:/app/models
      - ./modules:/app/modules
  auto-tuner:
    build:
      context: .
      dockerfile: services/auto_tuner/Dockerfile
    restart: unless-stopped
    environment:
      - AUTOTUNER_ENABLED=${AUTOTUNER_ENABLED:-true}
    depends_on: [ rag-api ]
volumes:
  qdrant_data:
