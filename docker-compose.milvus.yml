version: "3.9"

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.12
    command: >
      etcd
      --name etcd0
      --data-dir /etcd-data
      --advertise-client-urls http://etcd:2379
      --listen-client-urls http://0.0.0.0:2379
    ports:
      - "2379:2379"
    healthcheck:
      test: ["CMD","etcdctl","--endpoints=http://localhost:2379","endpoint","health"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    volumes:
      - etcd-data:/etcd-data

  minio:
    image: minio/minio:latest
    command: server /data --address :9000 --console-address :9001
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD-SHELL","curl -sf http://localhost:9000/minio/health/ready >/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - minio-data:/data

  milvus:
    image: milvusdb/milvus:v2.4.4
    command: ["milvus","run","standalone"]
    depends_on:
      etcd:
        condition: service_started
      minio:
        condition: service_healthy
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: ${MILVUS_BUCKET:-milvus}
    ports:
      - "19530:19530"   # gRPC
      - "9091:9091"     # REST/健康检查
    healthcheck:
      test: ["CMD-SHELL","sh -c 'command -v curl >/dev/null || (apt-get update >/dev/null 2>&1 && apt-get install -y curl >/dev/null 2>&1) && curl -sf http://localhost:9091/healthz | grep -qi ok'"]
      interval: 5s
      timeout: 3s
      retries: 40
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - milvus-data:/var/lib/milvus

volumes:
  etcd-data: {}
  minio-data: {}
  milvus-data: {}
