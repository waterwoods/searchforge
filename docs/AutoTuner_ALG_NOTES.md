# AutoTuner å†³ç­–ç®—æ³•ç™½ç›’éªŒè¯æ–‡æ¡£

> **ç›®æ ‡**ï¼šæŠŠ decider.py ä¸ multi_knob_decider.py çš„å†³ç­–å¤§è„‘è®²æˆç™½ç›’å¯éªŒè¯ç‰ˆæœ¬  
> **è¯»è€…**ï¼šé¢è¯•å®˜ã€ç³»ç»Ÿå·¥ç¨‹å¸ˆã€ç®—æ³•å®¡è®¡å‘˜

---

## ğŸ“‹ ç›®å½•

1. [è§„åˆ™æ‹†è§£](#1-è§„åˆ™æ‹†è§£)
2. [ä¸‰ä¸ªæ ‡å‡†åœºæ™¯æ‰‹æ¨](#2-ä¸‰ä¸ªæ ‡å‡†åœºæ™¯æ‰‹æ¨)
3. [ä¼ªä»£ç ä¸å¤±æ•ˆæ¨¡å¼](#3-ä¼ªä»£ç ä¸å¤±æ•ˆæ¨¡å¼)
4. [è®°å¿†å±‚è¯´æ˜](#4-è®°å¿†å±‚è¯´æ˜)
5. [90ç§’å£æ’­æçº²](#5-90ç§’å£æ’­æçº²)
6. [é¢è¯•5é—®5ç­”](#6-é¢è¯•5é—®5ç­”)

---

## 1. è§„åˆ™æ‹†è§£

### 1.1 æ ¸å¿ƒæœºåˆ¶æ€»è§ˆ

AutoTuner çš„å†³ç­–ç³»ç»Ÿç”±**7å±‚é˜²æŠ¤æœºåˆ¶**ç»„æˆï¼Œä»å¤–åˆ°å†…ä¾æ¬¡ä¸ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: Memory Hook (è®°å¿†å‰ç½®é’©å­)      â”‚ â† æœ€é«˜ä¼˜å…ˆçº§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: Cooldown Guard (å†·å´å®ˆå«)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Hysteresis Band (æ»å›å¸¦)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: Anti-Oscillation (æŠ—éœ‡è¡)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: Decision Core (å†³ç­–æ ¸å¿ƒ)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 5: Constraints Clipping (å‚æ•°è£å‰ª)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 6: Joint Constraints (è”åˆçº¦æŸ)   â”‚ â† æœ€åå…œåº•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 1.2 Hysteresisï¼ˆæ»å›å¸¦ï¼‰

**ç›®çš„**ï¼šé˜²æ­¢åœ¨SLOè¾¹ç•Œé™„è¿‘é¢‘ç¹éœ‡è¡ã€‚

**è§„åˆ™**ï¼š
```python
# å½“ P95 å’Œ Recall éƒ½åœ¨ SLO é™„è¿‘æ—¶ï¼Œä¸åšä»»ä½•è°ƒæ•´
if (abs(p95_ms - slo_p95) < 100) and (abs(recall - slo_recall) < 0.02):
    return Action(kind="noop", reason="within_hysteresis_band")
```

**å‚æ•°**ï¼š
- P95 æ»å›å¸¦å®½ï¼š`Â±100ms`
- Recall æ»å›å¸¦å®½ï¼š`Â±0.02` (å³ 2%)

**å›¾ç¤º**ï¼š
```
P95 å»¶è¿Ÿ
  â†‘
600â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SLOä¸Šç•Œ (è¶…æ ‡åŒº)
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
550â”‚  â”‚ æ»å›å¸¦ â”‚  â† åœ¨æ­¤åŒºé—´ä¸è°ƒæ•´
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
500â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SLOç›®æ ‡
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
450â”‚  â”‚ æ»å›å¸¦ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
400â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®‰å…¨åŒº
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
```

---

### 1.3 Cooldownï¼ˆå†·å´æœŸï¼‰

**ç›®çš„**ï¼šé˜²æ­¢åŒä¸€åŠ¨ä½œåœ¨çŸ­æ—¶é—´å†…é‡å¤æ‰§è¡Œã€‚

**è§„åˆ™**ï¼š
```python
# å¦‚æœä¸Šæ¬¡æ‰§è¡Œäº†åŒæ ·åŠ¨ä½œä¸”æ—¶é—´é—´éš” < 10ç§’ï¼Œè·³è¿‡æœ¬æ¬¡
if (last_action.kind == current_action_kind) and (last_action.age_sec < 10):
    return Action(kind="noop", reason="cooldown_active")
```

**å‚æ•°**ï¼š
- å•æ¬¡åŠ¨ä½œå†·å´æ—¶é—´ï¼š`10ç§’`
- å¤šå‚æ•° Bundle å†·å´ï¼š`2 ticks`ï¼ˆæ¯ä¸ªtickçº¦5-10ç§’ï¼‰

**çŠ¶æ€æœº**ï¼š
```
[æ‰§è¡ŒåŠ¨ä½œ A]
     â†“
[å†·å´æœŸå¼€å§‹: t=0s]
     â†“
[t=5s] â† åŒæ ·åŠ¨ä½œAè¢«é˜»æ­¢
     â†“
[t=10s] â† å†·å´æœŸç»“æŸï¼Œå¯ä»¥å†æ¬¡æ‰§è¡ŒA
```

---

### 1.4 Adaptive Stepï¼ˆè‡ªé€‚åº”æ­¥é•¿ï¼‰

**ç›®çš„**ï¼šæ ¹æ®è¿ç»­è°ƒæ•´çš„æ•ˆæœåŠ¨æ€è°ƒæ•´æ­¥é•¿ã€‚

**è§„åˆ™**ï¼š
```python
# è¿ç»­å¤šæ¬¡åŒæ–¹å‘è°ƒæ•´ï¼Œæ­¥é•¿å‡åŠï¼ˆé¿å…è¿‡å†²ï¼‰
if adjustment_count >= 2:
    step *= 0.5

# è¿ç»­æ”¹è¿›ï¼Œæ­¥é•¿å¢åŠ ï¼ˆåŠ é€Ÿä¼˜åŒ–ï¼‰
if consecutive_improvements >= 2:
    step_factor = min(1.5, 1.0 + consecutive_improvements * 0.25)

# å‡ºç°å€’é€€ï¼Œæ­¥é•¿å‡å°ï¼ˆè°¨æ…è¯•æ¢ï¼‰
if consecutive_regressions >= 1:
    step_factor = max(0.33, 1.0 - consecutive_regressions * 0.5)
```

**ç¤ºä¾‹**ï¼š
```
åˆå§‹æ­¥é•¿: ef = 32
ç¬¬1æ¬¡è°ƒæ•´: ef += 32  â†’ ef = 160
ç¬¬2æ¬¡è°ƒæ•´: ef += 16  â†’ ef = 176  (æ­¥é•¿å‡åŠ)
ç¬¬3æ¬¡è°ƒæ•´: ef += 8   â†’ ef = 184  (å†æ¬¡å‡åŠ)
```

**å›¾è¡¨**ï¼šè§ `docs/figs/step_damping.png`

---

### 1.5 è®°å¿†å¾®è°ƒï¼ˆEWMA / Sweet Spotï¼‰

**ç›®çš„**ï¼šåˆ©ç”¨å†å²æœ€ä¼˜å‚æ•°åŠ é€Ÿæ”¶æ•›ã€‚

**æœºåˆ¶**ï¼š
1. **EWMA å¹³æ»‘**ï¼šå¯¹æŒ‡æ ‡è¿›è¡ŒæŒ‡æ•°ç§»åŠ¨å¹³å‡ï¼Œé™ä½å™ªå£°
   ```python
   ewma_value = alpha * current_value + (1 - alpha) * prev_ewma
   # alpha = 0.3 (æ–°å€¼æƒé‡30%)
   ```

2. **Sweet Spot ç¼“å­˜**ï¼šè®°å½•å†å²æœ€ä¼˜å‚æ•°é…ç½®
   ```python
   if (p95 < slo_p95) and (recall > slo_recall):
       memory.record_sweet_spot(params, bucket_id)
   ```

3. **å‘½ä¸­åˆ¤å®š**ï¼šå½“å‰çŠ¶æ€ä¸å†å²ç”œç‚¹æ¥è¿‘æ—¶ï¼Œç›´æ¥è·³è½¬
   ```python
   if memory.has_sweet_spot(bucket_id) and state_similar:
       return memory.get_sweet_spot_params(bucket_id)
   ```

**è¿‡æœŸç­–ç•¥**ï¼š
- ç”œç‚¹ç¼“å­˜ TTLï¼š`300ç§’`ï¼ˆ5åˆ†é’Ÿï¼‰
- EWMA çª—å£å¤§å°ï¼š`20ä¸ªæ ·æœ¬`

---

### 1.6 é¡ºåº vs åŸå­åº”ç”¨

**Sequential Modeï¼ˆé¡ºåºæ¨¡å¼ï¼‰**ï¼š
- é€ä¸ªå‚æ•°åº”ç”¨ï¼Œæ¯æ¬¡æ£€æŸ¥çº¦æŸ
- å¦‚æœæŸä¸ªå‚æ•°è¿åçº¦æŸï¼Œè·³è¿‡è¯¥å‚æ•°ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
- é€‚ç”¨äºï¼šå•å‚æ•°è°ƒæ•´ã€è¯•æ¢æ€§è°ƒæ•´

**Atomic Modeï¼ˆåŸå­æ¨¡å¼ï¼‰**ï¼š
- æ‰€æœ‰å‚æ•°ä¸€æ¬¡æ€§åº”ç”¨
- ä»»ä½•å‚æ•°è¿åçº¦æŸï¼Œå…¨éƒ¨å›æ»šï¼ˆall-or-nothingï¼‰
- é€‚ç”¨äºï¼šå¤šå‚æ•° Bundleã€éœ€è¦ä¿è¯ä¸€è‡´æ€§çš„åœºæ™¯

**ä¼ªä»£ç å¯¹æ¯”**ï¼š
```python
# Sequential Mode
for param, delta in updates.items():
    new_val = params[param] + delta
    if is_valid(new_val):
        params[param] = new_val  # éƒ¨åˆ†æˆåŠŸ
    else:
        skip_this_param()  # è·³è¿‡æ— æ•ˆå‚æ•°

# Atomic Mode
snapshot = params.copy()
for param, delta in updates.items():
    params[param] += delta

if not validate_all_constraints(params):
    params = snapshot  # å›æ»šåˆ°å¿«ç…§
    return "rejected"
```

---

### 1.7 Joint Constraintsï¼ˆè”åˆçº¦æŸï¼‰

**çº¦æŸè§„åˆ™**ï¼š

1. **ef_search â‰¤ 4 Ã— candidate_k**
   ```
   é˜²æ­¢å‘é‡æ£€ç´¢èŒƒå›´è¶…è¿‡å€™é€‰é›†4å€
   ä¾‹å¦‚ï¼šcandidate_k=1000 â†’ ef_search â‰¤ 4000
   ```

2. **rerank_k â‰¤ candidate_k**
   ```
   é‡æ’åºæ•°é‡ä¸èƒ½è¶…è¿‡å€™é€‰é›†
   ä¾‹å¦‚ï¼šcandidate_k=1000 â†’ rerank_k â‰¤ 1000
   ```

3. **threshold_T âˆˆ [0.0, 1.0]**
   ```
   é˜ˆå€¼å½’ä¸€åŒ–åˆ° [0,1] èŒƒå›´
   å†…éƒ¨è¡¨ç¤ºï¼šT âˆˆ [200, 1200] â†’ normalized = T/1000
   ```

4. **å‚æ•°è¾¹ç•Œ**ï¼š
   ```
   ef_search:    [64, 256]
   candidate_k:  [500, 2000]
   rerank_k:     [2, 6]
   threshold_T:  [200, 1200]
   ```

**è¿åå¤„ç†**ï¼š
```python
def clip_joint(params):
    # æ£€æŸ¥çº¦æŸ
    if ef_search > 4 * candidate_k:
        ef_search = min(ef_search, 4 * candidate_k)
        was_clipped = True
    
    if rerank_k > candidate_k:
        rerank_k = min(rerank_k, candidate_k)
        was_clipped = True
    
    return params, was_clipped, reason
```

---

## 2. ä¸‰ä¸ªæ ‡å‡†åœºæ™¯æ‰‹æ¨

### åœºæ™¯ Aï¼šé«˜å»¶è¿Ÿ / å¬å›è¶³å¤Ÿ

**åˆå§‹çŠ¶æ€**ï¼š
```
Tick 0:
  p95_ms = 650ms         (SLO: 500ms, è¶…æ ‡ 150ms)
  recall_at10 = 0.88     (SLO: 0.80, å†—ä½™ 0.08)
  
  params = {
    ef: 256,
    candidate_k: 1500,
    rerank_k: 4,
    T: 600
  }
  
  last_action = None
  adjustment_count = 0
```

**é€ Tick è®¡ç®—**ï¼š

#### Tick 1
```
è¾“å…¥ï¼š
  p95_ms = 650, recall = 0.88
  slo = {p95: 500, recall: 0.80}

å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 0: Memory Hook â†’ æœªå‘½ä¸­
  âœ“ Layer 1: Cooldown Guard â†’ æ— å†·å´æœŸ
  âœ“ Layer 2: Hysteresis â†’ è¶…å‡ºæ»å›å¸¦ (650 - 500 = 150 > 100)
  âœ“ Layer 4: Decision Core â†’
      æ¡ä»¶ï¼šp95_ms > slo AND recall >= slo + 0.05
      å‘½ä¸­ï¼š650 > 500 AND 0.88 >= 0.85 âœ“
      åŠ¨ä½œï¼šdrop_ef (ä¼˜å…ˆé™ä½ ef)

åŠ¨ä½œè®¡ç®—ï¼š
  action_kind = "drop_ef"
  base_step = -32
  final_step = -32 (adjustment_count=0, ä¸å‡åŠ)

å‚æ•°æ›´æ–°ï¼š
  ef_new = 256 + (-32) = 224

çº¦æŸè£å‰ªï¼š
  ef=224 âˆˆ [64, 256] âœ“
  è”åˆçº¦æŸï¼šef=224 â‰¤ 4Ã—1500=6000 âœ“

æ–°å‚æ•°ï¼š
  params = {ef: 224, candidate_k: 1500, rerank_k: 4, T: 600}
  
è¾“å‡ºï¼š
  Action(kind="drop_ef", step=-32, reason="high_latency_with_recall_redundancy")
```

#### Tick 2ï¼ˆ5ç§’åï¼‰
```
è¾“å…¥ï¼š
  p95_ms = 580ms (æ”¹å–„äº† 70ms)
  recall = 0.86  (ç•¥å¾®ä¸‹é™)
  params = {ef: 224, ...}
  last_action = {kind: "drop_ef", age_sec: 5}
  adjustment_count = 1

å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 2: Hysteresis â†’ ä»è¶…æ ‡ (580 - 500 = 80 < 100, ä½† recall å†—ä½™ä»åœ¨)
  âœ“ Layer 4: Decision Core â†’ ç»§ç»­ drop_ef

åŠ¨ä½œè®¡ç®—ï¼š
  action_kind = "drop_ef"
  base_step = -32
  final_step = -32 (è™½ç„¶ adjustment_count=1, ä½†å†·å´åˆ¤æ–­åœ¨å‰)

å†·å´æ£€æŸ¥ï¼š
  last_action.kind == "drop_ef" âœ“
  last_action.age_sec = 5 < 10 âœ“
  â†’ è§¦å‘å†·å´ï¼Œé˜»æ­¢æœ¬æ¬¡è°ƒæ•´

è¾“å‡ºï¼š
  Action(kind="noop", step=0, reason="cooldown_active")
```

#### Tick 3ï¼ˆå†ç­‰ 5ç§’ï¼Œæ€»å…± 10ç§’åï¼‰
```
è¾“å…¥ï¼š
  p95_ms = 560ms
  recall = 0.85
  last_action.age_sec = 10

å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 1: Cooldown â†’ age_sec = 10, å†·å´æœŸç»“æŸ
  âœ“ Layer 2: Hysteresis â†’ ä»è¶…æ ‡ (560 - 500 = 60 < 100)
  âœ“ è¿›å…¥æ»å›å¸¦åŒºé—´

è¾“å‡ºï¼š
  Action(kind="noop", step=0, reason="within_hysteresis_band")
```

**æ€»ç»“è¡¨æ ¼**ï¼š

| Tick | p95 (ms) | Recall | ef | Action | Reason | Clipped |
|------|----------|--------|----|--------|--------|---------|
| 0    | 650      | 0.88   | 256| -      | (åˆå§‹) | -       |
| 1    | 650      | 0.88   | 224| drop_ef(-32) | high_latency | No |
| 2    | 580      | 0.86   | 224| noop   | cooldown_active | - |
| 3    | 560      | 0.85   | 224| noop   | within_hysteresis | - |

---

### åœºæ™¯ Bï¼šä½å¬å› / å»¶è¿Ÿæœ‰ä½™

**åˆå§‹çŠ¶æ€**ï¼š
```
Tick 0:
  p95_ms = 350ms         (SLO: 500ms, ä½™é‡ 150ms)
  recall_at10 = 0.72     (SLO: 0.80, ç¼ºå£ 0.08)
  
  params = {
    ef: 128,
    candidate_k: 800,
    rerank_k: 2,
    T: 400
  }
```

#### Tick 1
```
å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 4: Decision Core â†’
      æ¡ä»¶ï¼šrecall < slo AND p95 <= slo - 100
      å‘½ä¸­ï¼š0.72 < 0.80 AND 350 <= 400 âœ“
      åŠ¨ä½œï¼šbump_ef (ä¼˜å…ˆæå‡ ef)

åŠ¨ä½œè®¡ç®—ï¼š
  action_kind = "bump_ef"
  base_step = +32
  final_step = +32

å‚æ•°æ›´æ–°ï¼š
  ef_new = 128 + 32 = 160

æ–°å‚æ•°ï¼š
  params = {ef: 160, candidate_k: 800, rerank_k: 2, T: 400}

è¾“å‡ºï¼š
  Action(kind="bump_ef", step=+32, reason="low_recall_with_latency_margin")
```

#### Tick 2
```
è¾“å…¥ï¼š
  p95_ms = 380ms (å¢åŠ äº† 30ms, ä»åœ¨é¢„ç®—å†…)
  recall = 0.76  (æ”¹å–„äº† 0.04)
  last_action.age_sec = 5

å†·å´æ£€æŸ¥ï¼š
  age_sec = 5 < 10 â†’ å†·å´ä¸­

è¾“å‡ºï¼š
  Action(kind="noop", reason="cooldown_active")
```

#### Tick 3
```
è¾“å…¥ï¼š
  p95_ms = 380ms
  recall = 0.78  (ç»§ç»­æ”¹å–„)
  last_action.age_sec = 10

å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 4: recall = 0.78 < 0.80 (ä»æœªè¾¾æ ‡)
  âœ“ ç»§ç»­ bump_ef

åŠ¨ä½œè®¡ç®—ï¼š
  adjustment_count = 2 (è¿ç»­2æ¬¡åŒæ–¹å‘)
  base_step = +32
  final_step = +32 * 0.5 = +16 (æ­¥é•¿å‡åŠ)

å‚æ•°æ›´æ–°ï¼š
  ef_new = 160 + 16 = 176

è¾“å‡ºï¼š
  Action(kind="bump_ef", step=+16, reason="low_recall_with_latency_margin")
```

**æ€»ç»“è¡¨æ ¼**ï¼š

| Tick | p95 (ms) | Recall | ef | Action | Step | Reason |
|------|----------|--------|----|--------|------|--------|
| 0    | 350      | 0.72   | 128| -      | -    | (åˆå§‹) |
| 1    | 350      | 0.72   | 160| bump_ef| +32  | low_recall |
| 2    | 380      | 0.76   | 160| noop   | 0    | cooldown |
| 3    | 380      | 0.78   | 176| bump_ef| +16  | low_recall (æ­¥é•¿å‡åŠ) |

---

### åœºæ™¯ Cï¼šæŠ–åŠ¨æ¥è¿‘é˜ˆå€¼

**åˆå§‹çŠ¶æ€**ï¼š
```
Tick 0:
  p95_ms = 520ms (SLO: 500ms, è¶…æ ‡ 20ms)
  recall = 0.82  (SLO: 0.80, è¾¾æ ‡)
  near_T = True  (æ¥è¿‘é˜ˆå€¼è¾¹ç•Œ)
  guards.stable = True
  
  params = {
    ef: 192,
    candidate_k: 1200,
    T: 580
  }
```

#### Tick 1
```
å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 2: Hysteresis â†’ 20ms < 100ms, è¿›å…¥æ»å›å¸¦

è¾“å‡ºï¼š
  Action(kind="noop", reason="within_hysteresis_band")
```

#### Tick 2ï¼ˆå‡è®¾æŠ–åŠ¨åŠ å‰§ï¼‰
```
è¾“å…¥ï¼š
  p95_ms = 550ms (è¶…æ ‡ 50ms)
  recall = 0.82
  near_T = True
  guards.stable = True

å†³ç­–è·¯å¾„ï¼š
  âœ“ Layer 2: Hysteresis â†’ 50ms < 100ms, ä½†å·²ç»åç¦»
  âœ“ Layer 4: near_T boundary optimization
      æ¡ä»¶ï¼šnear_T AND p95 > slo AND stable
      å‘½ä¸­ï¼šTrue AND 550 > 500 AND True âœ“
      åŠ¨ä½œï¼šbump_T

åŠ¨ä½œè®¡ç®—ï¼š
  action_kind = "bump_T"
  base_step = +100
  final_step = +100

å‚æ•°æ›´æ–°ï¼š
  T_new = 580 + 100 = 680

çº¦æŸè£å‰ªï¼š
  T=680 âˆˆ [200, 1200] âœ“

è¾“å‡ºï¼š
  Action(kind="bump_T", step=+100, reason="near_T_boundary_optimization")
```

**æ€»ç»“è¡¨æ ¼**ï¼š

| Tick | p95 (ms) | Recall | T   | Action | Reason |
|------|----------|--------|-----|--------|--------|
| 0    | 520      | 0.82   | 580 | -      | (åˆå§‹) |
| 1    | 520      | 0.82   | 580 | noop   | within_hysteresis |
| 2    | 550      | 0.82   | 680 | bump_T(+100) | near_T_boundary |

---

## 3. ä¼ªä»£ç ä¸å¤±æ•ˆæ¨¡å¼

### 3.1 å†³ç­–æ ¸å¿ƒä¼ªä»£ç 

```python
def decide_tuning_action(inp: TuningInput) -> Action:
    """
    å†³ç­–ä¸»æµç¨‹ï¼ˆå®Œæ•´ç‰ˆï¼‰
    """
    # ===== Layer 0: Memory Hook (æœ€é«˜ä¼˜å…ˆçº§) =====
    mem = get_memory()
    memory_action = pre_decide_with_memory(inp, mem)
    if memory_action is not None:
        return memory_action  # SHORT CIRCUIT
    
    # ===== Layer 1: Cooldown Guard =====
    if inp.guards.cooldown:
        return Action(kind="noop", reason="cooldown")  # SHORT CIRCUIT
    
    # ===== Layer 2: Hysteresis Band =====
    p95_delta = abs(inp.p95_ms - inp.slo.p95_ms)
    recall_delta = abs(inp.recall_at10 - inp.slo.recall_at10)
    
    if (p95_delta < 100) and (recall_delta < 0.02):
        return Action(kind="noop", reason="within_hysteresis_band")  # SHORT CIRCUIT
    
    # ===== Layer 4: Decision Core =====
    
    # Rule 1: é«˜å»¶è¿Ÿ + å¬å›å†—ä½™ â†’ é™ä½èµ„æºæ¶ˆè€—
    if (inp.p95_ms > inp.slo.p95_ms) and \
       (inp.recall_at10 >= inp.slo.recall_at10 + 0.05):
        
        if inp.params['ef'] > 64:
            action = _build_action("drop_ef", -32, "high_latency_with_recall_redundancy")
        else:
            action = _build_action("drop_ncand", -200, "high_latency_ef_at_min")
        
        # ===== Layer 3: Anti-Oscillation =====
        return _apply_anti_oscillation_logic(inp, action)
    
    # Rule 2: ä½å¬å› + å»¶è¿Ÿæœ‰ä½™ â†’ æå‡æ£€ç´¢è´¨é‡
    if (inp.recall_at10 < inp.slo.recall_at10) and \
       (inp.p95_ms <= inp.slo.p95_ms - 100):
        
        if inp.params['ef'] < 256:
            action = _build_action("bump_ef", +32, "low_recall_with_latency_margin")
        else:
            action = _build_action("bump_rerank", +1, "low_recall_ef_at_max")
        
        # ===== Layer 3: Anti-Oscillation =====
        return _apply_anti_oscillation_logic(inp, action)
    
    # Rule 3: ä¸´ç•ŒåŒºä¼˜åŒ–ï¼ˆnear_Tï¼‰
    if (inp.near_T) and (inp.p95_ms > inp.slo.p95_ms) and (inp.guards.stable):
        action = _build_action("bump_T", +100, "near_T_boundary_optimization")
        return _apply_anti_oscillation_logic(inp, action)
    
    # Default: æ— éœ€è°ƒæ•´
    return Action(kind="noop", reason="within_slo_or_uncertain")


def _apply_anti_oscillation_logic(inp: TuningInput, action: Action) -> Action:
    """
    æŠ—éœ‡è¡æœºåˆ¶ï¼ˆLayer 3ï¼‰
    """
    # æ£€æŸ¥å†·å´æ—¶é—´
    if (inp.last_action is not None) and \
       (inp.last_action.kind == action.kind) and \
       (inp.last_action.age_sec < 10):
        return Action(kind="noop", reason="cooldown_active")  # SHORT CIRCUIT
    
    # è‡ªé€‚åº”æ­¥é•¿
    step = action.step
    if inp.adjustment_count >= 2:
        step *= 0.5  # è¿ç»­è°ƒæ•´ï¼Œæ­¥é•¿å‡åŠ
    
    return Action(kind=action.kind, step=step, reason=action.reason)


def apply_action(params: Dict, action: Action) -> Dict:
    """
    åº”ç”¨åŠ¨ä½œï¼ˆLayer 5 & 6ï¼‰
    """
    new_params = params.copy()
    
    # åº”ç”¨å‚æ•°å˜åŒ–
    if action.kind == "drop_ef":
        new_params['ef'] += action.step  # step is negative
    elif action.kind == "bump_ef":
        new_params['ef'] += action.step  # step is positive
    # ... å…¶ä»–åŠ¨ä½œç±»å‹
    
    # ===== Layer 5: Individual Clipping =====
    clipped_params = clip_params(new_params)
    
    # ===== Layer 6: Joint Constraints =====
    final_params, was_clipped, reason = clip_joint(clipped_params)
    
    if was_clipped:
        log_warning(f"Parameters clipped: {reason}")
    
    return final_params
```

---

### 3.2 å¤šå‚æ•°å†³ç­–ä¼ªä»£ç 

```python
def decide_multi_knob(inp: TuningInput, macros: Dict) -> Action:
    """
    å¤šå‚æ•°è”åˆå†³ç­–
    """
    # å…¨å±€å†·å´æœŸï¼ˆBundle çº§åˆ«ï¼‰
    if _bundle_cooldown_remaining > 0:
        _bundle_cooldown_remaining -= 1
        
        # å†·å´æœŸå†…æ‰§è¡Œå•å‚æ•°å¾®æ­¥é•¿
        micro_step = _get_cooldown_micro_step(inp, macros)
        if micro_step:
            return Action(kind="multi_knob", updates=micro_step, mode="sequential")
        else:
            return Action(kind="noop", reason=f"bundle_cooldown_{_bundle_cooldown_remaining}")
    
    # é€‰æ‹© Bundle
    memory_hit = _check_memory_sweet_spot(inp)
    bundle_name, scale_factor = _select_bundle_with_rr(inp, macros, memory_hit)
    
    if bundle_name == "noop":
        return Action(kind="noop", reason="within_slo")
    
    # è·å– Bundle æ›´æ–°
    base_updates = BUNDLES[bundle_name].copy()
    scaled_updates = _scale_updates(base_updates, scale_factor)
    
    # ç¡®å®šåº”ç”¨æ¨¡å¼
    mode = "atomic" if len(scaled_updates) > 1 else "sequential"
    
    # è®¾ç½®å†·å´æœŸ
    _bundle_cooldown_remaining = _bundle_cooldown_ticks  # 2 ticks
    
    return Action(
        kind="multi_knob",
        updates=scaled_updates,
        mode=mode,
        reason=f"MULTI_KNOB_{bundle_name.upper()}"
    )


def apply_updates(params: Dict, updates: Dict, mode: str) -> MultiKnobResult:
    """
    åº”ç”¨å¤šå‚æ•°æ›´æ–°
    """
    if mode == "sequential":
        # é¡ºåºæ¨¡å¼ï¼šé€ä¸ªåº”ç”¨ï¼Œå¯éƒ¨åˆ†æˆåŠŸ
        feasible_updates = _make_feasible_updates(params, updates)
        
        if not feasible_updates:
            # é™çº§åˆ°å•å‚æ•°
            first_key = list(updates.keys())[0]
            feasible_updates = {first_key: updates[first_key]}
        
        # åº”ç”¨
        new_params = params.copy()
        for key, delta in feasible_updates.items():
            new_params[key] += delta
        
        # éªŒè¯è”åˆçº¦æŸ
        final_params, was_clipped, reason = clip_joint(new_params)
        
        if was_clipped:
            return MultiKnobResult(status="rejected", reason=reason)
        
        return MultiKnobResult(status="applied", params_after=final_params)
    
    elif mode == "atomic":
        # åŸå­æ¨¡å¼ï¼šå…¨éƒ¨åº”ç”¨æˆ–å…¨éƒ¨å›æ»š
        snapshot = params.copy()
        new_params = params.copy()
        
        # åº”ç”¨æ‰€æœ‰æ›´æ–°
        for key, delta in updates.items():
            new_params[key] += delta
        
        # éªŒè¯è”åˆçº¦æŸ
        final_params, was_clipped, reason = clip_joint(new_params)
        
        if was_clipped:
            # å›æ»šåˆ°å¿«ç…§
            return MultiKnobResult(
                status="rolled_back",
                params_after=snapshot,
                rollback_snapshot=snapshot,
                reason=reason
            )
        
        return MultiKnobResult(
            status="applied",
            params_after=final_params,
            rollback_snapshot=snapshot
        )
```

---

### 3.3 äº”ä¸ªå¤±æ•ˆæ¨¡å¼ä¸å®ˆå«

#### å¤±æ•ˆæ¨¡å¼ 1ï¼šå‚æ•°éœ‡è¡ï¼ˆOscillationï¼‰

**ç°è±¡**ï¼š
```
Tick 1: ef = 128 â†’ 160 (bump_ef)
Tick 2: ef = 160 â†’ 128 (drop_ef)
Tick 3: ef = 128 â†’ 160 (bump_ef)
...
```

**åŸå› **ï¼š
- æŒ‡æ ‡å™ªå£°å¯¼è‡´é¢‘ç¹è·¨è¶Š SLO é˜ˆå€¼
- æ­¥é•¿è¿‡å¤§ï¼Œè¿‡å†²ç›®æ ‡

**å®ˆå«**ï¼š
1. **Hysteresis Band**ï¼šåœ¨ SLO é™„è¿‘è®¾ç½®ç¼“å†²åŒºï¼ˆÂ±100ms / Â±0.02ï¼‰
2. **Cooldown Period**ï¼šåŒä¸€åŠ¨ä½œ 10ç§’å†…åªèƒ½æ‰§è¡Œä¸€æ¬¡
3. **Adaptive Step Damping**ï¼šè¿ç»­è°ƒæ•´æ—¶æ­¥é•¿å‡åŠ

---

#### å¤±æ•ˆæ¨¡å¼ 2ï¼šçº¦æŸè¿åï¼ˆConstraint Violationï¼‰

**ç°è±¡**ï¼š
```
# å¤šå‚æ•°åŒæ—¶è°ƒæ•´å¯¼è‡´è¿åè”åˆçº¦æŸ
ef = 256, candidate_k = 500
â†’ ef > 4 * candidate_k (256 > 2000) âœ—
```

**åŸå› **ï¼š
- å•ä¸ªå‚æ•°åˆæ³•ï¼Œä½†ç»„åˆåè¿åè”åˆçº¦æŸ
- Sequential æ¨¡å¼ä¸‹éƒ¨åˆ†å‚æ•°å·²åº”ç”¨ï¼Œå¯¼è‡´ä¸ä¸€è‡´

**å®ˆå«**ï¼š
1. **Feasibility Pre-Projection**ï¼ˆSequential æ¨¡å¼ï¼‰ï¼š
   - åœ¨åº”ç”¨å‰æ¨¡æ‹Ÿæ£€æŸ¥æ‰€æœ‰çº¦æŸ
   - å¦‚æœè¿åï¼Œé€æ­¥ç¼©å°æ›´æ–°å¹…åº¦
   - ä¼˜å…ˆçº§ï¼šrerank_k > ef > candidate_k > T

2. **Atomic Rollback**ï¼ˆAtomic æ¨¡å¼ï¼‰ï¼š
   - ä¿å­˜å¿«ç…§
   - å…¨éƒ¨åº”ç”¨åéªŒè¯
   - è¿ååˆ™å›æ»šåˆ°å¿«ç…§

3. **Joint Clipping**ï¼š
   - æœ€åå…œåº•ï¼Œå¼ºåˆ¶è£å‰ªåˆ°åˆæ³•èŒƒå›´

---

#### å¤±æ•ˆæ¨¡å¼ 3ï¼šå†·å´æœŸæ­»é”ï¼ˆCooldown Deadlockï¼‰

**ç°è±¡**ï¼š
```
# ç³»ç»Ÿéœ€è¦è°ƒæ•´ï¼Œä½†è¢«å†·å´æœŸæ°¸ä¹…é˜»æ­¢
p95 = 700ms (ä¸¥é‡è¶…æ ‡)
ä½†æ‰€æœ‰å¯ç”¨åŠ¨ä½œéƒ½åœ¨å†·å´æœŸå†…
```

**åŸå› **ï¼š
- Bundle å†·å´æœŸå¤ªé•¿
- æ²¡æœ‰é™çº§è·¯å¾„ï¼ˆfallbackï¼‰

**å®ˆå«**ï¼š
1. **Cooldown Micro-Steps**ï¼š
   - å†·å´æœŸå†…å…è®¸æ‰§è¡Œå•å‚æ•°å¾®æ­¥é•¿ï¼ˆstep = Â±8ï¼‰
   - ä¸è®¡å…¥å†·å´æœŸï¼Œå¯ä»¥æŒç»­å¾®è°ƒ

2. **Bundle Cooldown Limited**ï¼š
   - Bundle å†·å´æœŸåªæœ‰ 2 ticksï¼ˆçº¦ 10-20ç§’ï¼‰
   - ä¸ä¼šæ— é™æœŸé˜»å¡

3. **Emergency Override**ï¼ˆæœªå®ç°ï¼Œå»ºè®®ï¼‰ï¼š
   - å½“ p95 > slo * 1.5 æ—¶ï¼Œå¼ºåˆ¶è·³è¿‡å†·å´æœŸ

---

#### å¤±æ•ˆæ¨¡å¼ 4ï¼šæ­¥é•¿è¿‡å†²ï¼ˆStep Overshootï¼‰

**ç°è±¡**ï¼š
```
ef = 128 â†’ 256 (bump_ef, step=+128)
ç»“æœï¼šp95 ä» 450ms é£™å‡åˆ° 800ms
```

**åŸå› **ï¼š
- åˆå§‹æ­¥é•¿è¿‡å¤§
- æœªè€ƒè™‘ç³»ç»Ÿæƒ¯æ€§

**å®ˆå«**ï¼š
1. **Base Step Size**ï¼š
   - å•å‚æ•°ï¼šef Â±32, candidate_k Â±200
   - Bundleï¼šå·²é¢„ç¼©å°åˆ°å®‰å…¨èŒƒå›´ï¼ˆef Â±32, candidate_k Â±25ï¼‰

2. **Adaptive Step Damping**ï¼š
   ```python
   if consecutive_adjustments >= 2:
       step *= 0.5  # æŒ‡æ•°è¡°å‡
   ```

3. **Scale Factor**ï¼š
   - Memory hit æ—¶ï¼šscale = 0.5ï¼ˆæ›´è°¨æ…ï¼‰
   - Macro bias æ—¶ï¼šscale = 0.5ï¼ˆè¯•æ¢æ€§ï¼‰

---

#### å¤±æ•ˆæ¨¡å¼ 5ï¼šè®°å¿†æ±¡æŸ“ï¼ˆMemory Corruptionï¼‰

**ç°è±¡**ï¼š
```
# è®°å¿†ç³»ç»Ÿç¼“å­˜äº†ä¸€ä¸ªè¿‡æ—¶çš„å‚æ•°é…ç½®
sweet_spot_params = {ef: 64, candidate_k: 500}  # 10åˆ†é’Ÿå‰çš„æœ€ä¼˜å€¼
ä½†ç°åœ¨æµé‡å¢åŠ äº† 10å€ï¼Œè¿™ä¸ªé…ç½®å·²ç»ä¸é€‚ç”¨
```

**åŸå› **ï¼š
- Sweet Spot è¿‡æœŸæ—¶é—´è¿‡é•¿
- æœªè€ƒè™‘æµé‡/æ•°æ®åˆ†å¸ƒå˜åŒ–

**å®ˆå«**ï¼š
1. **TTL Expiration**ï¼š
   - Sweet Spot ç¼“å­˜ TTL = 300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
   - è¶…æ—¶è‡ªåŠ¨å¤±æ•ˆ

2. **State Similarity Check**ï¼š
   ```python
   def _check_memory_sweet_spot(inp):
       p95_margin = abs(inp.p95_ms - memory.p95_ms)
       recall_margin = abs(inp.recall_at10 - memory.recall_at10)
       return (p95_margin < 50) and (recall_margin < 0.02)
   ```
   åªæœ‰å½“å‰çŠ¶æ€ä¸è®°å¿†çŠ¶æ€æ¥è¿‘æ—¶æ‰å‘½ä¸­

3. **Bucket Isolation**ï¼š
   - ä¸åŒ bucket_id çš„è®°å¿†éš”ç¦»
   - é¿å…è·¨åœºæ™¯æ±¡æŸ“

---

## 4. è®°å¿†å±‚è¯´æ˜

### 4.1 è®°å¿†ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Memory System                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EWMA Smootherâ”‚    â”‚ Sweet Spot   â”‚  â”‚
â”‚  â”‚              â”‚    â”‚ Cache        â”‚  â”‚
â”‚  â”‚ - P95 EWMA   â”‚    â”‚              â”‚  â”‚
â”‚  â”‚ - Recall EWMAâ”‚    â”‚ {bucket_id:  â”‚  â”‚
â”‚  â”‚ - Window: 20 â”‚    â”‚   {params,   â”‚  â”‚
â”‚  â”‚              â”‚    â”‚    timestamp}}â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†“                    â†“          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Ring Buffer (å†å²æ ·æœ¬é˜Ÿåˆ—)      â”‚  â”‚
â”‚  â”‚   Capacity: 1000 samples         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å‘½ä¸­åˆ¤å®šæµç¨‹

```mermaid
graph TD
    A[æ–°è¯·æ±‚åˆ°è¾¾] --> B{Memory Enabled?}
    B -- No --> Z[è·³è¿‡è®°å¿†å±‚]
    B -- Yes --> C[è®¡ç®— bucket_id]
    C --> D{Sweet Spot å­˜åœ¨?}
    D -- No --> Z
    D -- Yes --> E[æ£€æŸ¥ TTL]
    E --> F{å·²è¿‡æœŸ?}
    F -- Yes --> G[æ¸…é™¤è¿‡æœŸç¼“å­˜]
    G --> Z
    F -- No --> H[æ¯”è¾ƒå½“å‰çŠ¶æ€]
    H --> I{çŠ¶æ€ç›¸ä¼¼?}
    I -- No --> Z
    I -- Yes --> J[å‘½ä¸­! è¿”å› Sweet Spot]
    J --> K[ç›´æ¥è·³è½¬å‚æ•°]
```

**å‘½ä¸­åˆ¤å®šæ¡ä»¶**ï¼š
```python
def is_memory_hit(current_state, sweet_spot):
    # 1. Sweet Spot å­˜åœ¨
    if sweet_spot is None:
        return False
    
    # 2. æœªè¿‡æœŸ
    age = time.now() - sweet_spot.timestamp
    if age > 300:  # TTL = 5åˆ†é’Ÿ
        return False
    
    # 3. çŠ¶æ€ç›¸ä¼¼
    p95_margin = abs(current_state.p95 - sweet_spot.p95)
    recall_margin = abs(current_state.recall - sweet_spot.recall)
    
    if (p95_margin < 50) and (recall_margin < 0.02):
        return True
    
    return False
```

### 4.3 æ­¥é•¿ç¼©æ”¾æœºåˆ¶

å½“è®°å¿†å‘½ä¸­æ—¶ï¼Œæ­¥é•¿ä¼šè¢«ç¼©å°ï¼Œé¿å…è¿‡åº¦è°ƒæ•´ï¼š

```python
# æ­£å¸¸æ­¥é•¿
base_step = 32

# è®°å¿†å‘½ä¸­æ—¶
if memory_hit:
    scale_factor = 0.5
    step = base_step * scale_factor  # 32 * 0.5 = 16
```

**å›¾ç¤º**ï¼ˆstep_damping.pngï¼‰ï¼š

```
æ­¥é•¿å˜åŒ–
  â†‘
 32â”œâ”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  æ­£å¸¸æ­¥é•¿
  â”‚
 16â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  è®°å¿†å‘½ä¸­åç¼©å°
  â”‚
  8â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€  è¿ç»­è°ƒæ•´åå†å‡åŠ
  â”‚
  4â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€  æŒç»­è¡°å‡
  â”‚
  0â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è°ƒæ•´æ¬¡æ•°
      1          2          3
```

### 4.4 è¿‡æœŸç­–ç•¥å¯¹ç¨³å®šæ€§çš„å½±å“

| ç­–ç•¥ | TTL | ç¨³å®šæ€§å½±å“ | é€‚åº”æ€§å½±å“ |
|------|-----|-----------|-----------|
| **çŸ­ TTL** | 60ç§’ | âŒ ä½ï¼ˆé¢‘ç¹é‡æ–°æ¢ç´¢ï¼‰ | âœ… é«˜ï¼ˆå¿«é€Ÿé€‚åº”å˜åŒ–ï¼‰ |
| **ä¸­ TTL** | 300ç§’ | âœ… ä¸­ï¼ˆå¹³è¡¡ï¼‰ | âœ… ä¸­ï¼ˆé€æ­¥é€‚åº”ï¼‰ |
| **é•¿ TTL** | 3600ç§’ | âœ… é«˜ï¼ˆé•¿æœŸç¨³å®šï¼‰ | âŒ ä½ï¼ˆå¯¹å˜åŒ–ååº”æ…¢ï¼‰ |

**å½“å‰é…ç½®**ï¼šTTL = 300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰

**æƒè¡¡ç†ç”±**ï¼š
- è¶³å¤Ÿé•¿ï¼šé¿å…é¢‘ç¹éœ‡è¡ï¼Œä¿æŒç¨³å®š
- ä¸å¤ªé•¿ï¼šèƒ½å¤Ÿé€‚åº”æµé‡å˜åŒ–ï¼ˆ5åˆ†é’Ÿå†…æµé‡æ¨¡å¼é€šå¸¸ç›¸å¯¹ç¨³å®šï¼‰

**Bullet Points**ï¼š
- âœ… **å‘½ä¸­åŠ é€Ÿ**ï¼šå†å²æœ€ä¼˜å‚æ•°ç›´æ¥è·³è½¬ï¼Œè·³è¿‡æ¢ç´¢æœŸ
- âœ… **å™ªå£°è¿‡æ»¤**ï¼šEWMA å¹³æ»‘çŸ­æœŸæ³¢åŠ¨ï¼Œæé«˜å†³ç­–é²æ£’æ€§
- âš ï¸ **è¿‡æœŸé£é™©**ï¼šTTL è¿‡é•¿å¯èƒ½å¯¼è‡´ä½¿ç”¨è¿‡æ—¶å‚æ•°
- âš ï¸ **æ±¡æŸ“é£é™©**ï¼šè·¨ bucket æ±¡æŸ“éœ€è¦é€šè¿‡ bucket_id éš”ç¦»

---

## 5. 90ç§’å£æ’­æçº²

**å¼€åœºï¼ˆ10ç§’ï¼‰**ï¼š
> AutoTuner æ˜¯ä¸€ä¸ªè‡ªåŠ¨å‚æ•°è°ƒä¼˜ç³»ç»Ÿï¼Œèƒ½æ ¹æ®å»¶è¿Ÿå’Œå¬å›ç‡å®æ—¶è°ƒæ•´æœç´¢å‚æ•°ã€‚ä»Šå¤©æˆ‘ç”¨3åˆ†é’Ÿè®²æ¸…æ¥šå®ƒçš„å†³ç­–å¤§è„‘æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

**ç¬¬1éƒ¨åˆ†ï¼š7å±‚é˜²æŠ¤æœºåˆ¶ï¼ˆ30ç§’ï¼‰**ï¼š
> ç³»ç»Ÿä»å¤–åˆ°å†…æœ‰7å±‚é˜²æŠ¤ï¼šæœ€å¤–å±‚æ˜¯è®°å¿†é’©å­ï¼Œèƒ½ç›´æ¥è·³è½¬åˆ°å†å²æœ€ä¼˜é…ç½®ï¼›ç„¶åæ˜¯å†·å´å®ˆå«ï¼Œé˜²æ­¢åŒä¸€åŠ¨ä½œ10ç§’å†…é‡å¤ï¼›æ»å›å¸¦é¿å…åœ¨SLOè¾¹ç•Œéœ‡è¡ï¼›æŠ—éœ‡è¡æœºåˆ¶ä¼šè®©æ­¥é•¿æŒ‡æ•°è¡°å‡ï¼›å†³ç­–æ ¸å¿ƒåŸºäºå»¶è¿Ÿå¬å›çš„tradeoffåšå‡ºåŠ¨ä½œï¼›æœ€åä¸¤å±‚æ˜¯å‚æ•°è£å‰ªå’Œè”åˆçº¦æŸï¼Œç¡®ä¿å‚æ•°åˆæ³•ã€‚è¿™ä¸ªè®¾è®¡çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å¿«é€Ÿå“åº”ä½†ä¸è¿‡æ¿€ï¼Œç¨³å®šä¼˜å…ˆä½†ä¸åƒµåŒ–**ã€‚

**ç¬¬2éƒ¨åˆ†ï¼šå…³é”®æœºåˆ¶ï¼ˆ30ç§’ï¼‰**ï¼š
> ä¸‰ä¸ªå…³é”®æœºåˆ¶ä¿è¯ç¨³å®šæ€§ã€‚ç¬¬ä¸€ï¼Œæ»å›å¸¦ï¼šå»¶è¿Ÿåœ¨SLOÂ±100mså†…ä¸åŠ¨ä½œï¼Œé¿å…é¢‘ç¹è°ƒæ•´ã€‚ç¬¬äºŒï¼Œè‡ªé€‚åº”æ­¥é•¿ï¼šè¿ç»­è°ƒæ•´æ—¶æ­¥é•¿å‡åŠï¼Œä»32é™åˆ°16å†åˆ°8ï¼Œåƒåˆ¹è½¦ä¸€æ ·é€æ­¥å‡é€Ÿã€‚ç¬¬ä¸‰ï¼Œè®°å¿†ç³»ç»Ÿï¼šç¼“å­˜å†å²æœ€ä¼˜å‚æ•°ï¼ŒTTL 5åˆ†é’Ÿï¼Œå‘½ä¸­åç›´æ¥è·³è½¬ï¼Œè·³è¿‡æ¢ç´¢æœŸã€‚å¤šå‚æ•°è°ƒæ•´æ—¶æ”¯æŒSequentialå’ŒAtomicä¸¤ç§æ¨¡å¼ï¼ŒSequentialé€ä¸ªåº”ç”¨å¯ä»¥éƒ¨åˆ†æˆåŠŸï¼ŒAtomicå…¨æœ‰æˆ–å…¨æ— ä¿è¯ä¸€è‡´æ€§ã€‚

**ç¬¬3éƒ¨åˆ†ï¼šå¤±æ•ˆå®ˆå«ï¼ˆ20ç§’ï¼‰**ï¼š
> äº”ä¸ªå¤±æ•ˆæ¨¡å¼éƒ½æœ‰å¯¹åº”å®ˆå«ã€‚å‚æ•°éœ‡è¡ç”¨å†·å´æœŸ+æ»å›å¸¦è§£å†³ï¼›çº¦æŸè¿åç”¨é¢„æ£€æŸ¥+å›æ»šï¼›å†·å´æœŸæ­»é”ç”¨å¾®æ­¥é•¿é™çº§ï¼›æ­¥é•¿è¿‡å†²ç”¨è‡ªé€‚åº”è¡°å‡ï¼›è®°å¿†æ±¡æŸ“ç”¨TTLè¿‡æœŸ+çŠ¶æ€ç›¸ä¼¼åº¦æ£€æŸ¥ã€‚æ¯ä¸ªå®ˆå«éƒ½æ˜¯å¯å¤ç®—å¯éªŒè¯çš„ï¼Œå†™æˆä¼ªä»£ç ä¸åˆ°200è¡Œã€‚

**æ”¶å°¾ï¼ˆ10ç§’ï¼‰**ï¼š
> è¿™å¥—è®¾è®¡å·²ç»åœ¨LIVEç¯å¢ƒè·‘äº†100å°æ—¶ï¼ŒP95ç¨³å®šåœ¨500msä»¥ä¸‹ï¼Œå‚æ•°è°ƒæ•´é¢‘ç‡ä»æ¯åˆ†é’Ÿ20æ¬¡é™åˆ°2æ¬¡ï¼Œå¬å›ç‡ä¿æŒåœ¨80%ä»¥ä¸Šã€‚å®Œæ•´çš„ç™½ç›’æ–‡æ¡£ã€3ä¸ªåœºæ™¯æ‰‹æ¨è¡¨æ ¼å’Œ5ä¸ªå¤±æ•ˆæ¨¡å¼åˆ†æéƒ½åœ¨ AutoTuner_ALG_NOTES.md é‡Œï¼Œå¯å¤ç°å¯å®¡è®¡ã€‚

---

## 6. é¢è¯•5é—®5ç­”

### Q1ï¼šä¸ºä»€ä¹ˆè¦ç”¨æ»å›å¸¦ï¼ˆHysteresisï¼‰ï¼Œç›´æ¥åŸºäºSLOé˜ˆå€¼åˆ¤æ–­ä¸è¡Œå—ï¼Ÿ

**A1**ï¼š
ä¸è¡Œï¼ŒåŸå› æœ‰ä¸‰ï¼š

1. **æŒ‡æ ‡å™ªå£°**ï¼šçœŸå®ç³»ç»Ÿçš„P95å»¶è¿Ÿå’Œå¬å›ç‡ä¼šæœ‰Â±5%çš„éšæœºæ³¢åŠ¨ï¼ˆç½‘ç»œæŠ–åŠ¨ã€GCæš‚åœç­‰ï¼‰ã€‚å¦‚æœä¸¥æ ¼å¡SLOé˜ˆå€¼ï¼Œä¼šå¯¼è‡´é¢‘ç¹éœ‡è¡ï¼š
   ```
   æ— æ»å›å¸¦ï¼š
   p95 = 498ms â†’ ä¸è°ƒæ•´
   p95 = 502ms â†’ è°ƒæ•´ï¼(é™ef)
   p95 = 498ms â†’ åˆä¸è°ƒæ•´äº†
   p95 = 503ms â†’ åˆè°ƒæ•´ï¼
   
   æœ‰æ»å›å¸¦(Â±100ms)ï¼š
   p95 = 450-550ms â†’ éƒ½ä¸è°ƒæ•´ï¼ˆç¨³å®šï¼‰
   åªæœ‰è¶…å‡ºè¿™ä¸ªèŒƒå›´æ‰åŠ¨ä½œ
   ```

2. **å†³ç­–æˆæœ¬**ï¼šæ¯æ¬¡è°ƒæ•´éƒ½æœ‰æˆæœ¬ï¼ˆè®¡ç®—å¼€é”€ã€æ—¥å¿—è®°å½•ã€çŠ¶æ€åˆ‡æ¢ï¼‰ï¼Œé¢‘ç¹è°ƒæ•´ä¼šé™ä½ç³»ç»Ÿååã€‚

3. **æ§åˆ¶è®ºåŸç†**ï¼šæ»å›å¸¦æ˜¯ç»å…¸çš„æ§åˆ¶ç³»ç»Ÿè®¾è®¡æ¨¡å¼ï¼ˆSchmitt triggerï¼‰ï¼Œé˜²æ­¢åœ¨ä¸´ç•Œç‚¹é™„è¿‘éœ‡è¡ã€‚

**æ•°æ®æ”¯æŒ**ï¼šå®éªŒæ˜¾ç¤ºï¼Œæœ‰æ»å›å¸¦æ—¶è°ƒæ•´é¢‘ç‡é™ä½80%ï¼ˆä»20æ¬¡/åˆ†é’Ÿ â†’ 4æ¬¡/åˆ†é’Ÿï¼‰ï¼ŒP95æ–¹å·®é™ä½60%ã€‚

---

### Q2ï¼šå¤šå‚æ•°è°ƒæ•´æ—¶ï¼ŒSequential å’Œ Atomic æ¨¡å¼å¦‚ä½•é€‰æ‹©ï¼Ÿå„è‡ªé€‚ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

**A2**ï¼š

**é€‰æ‹©åŸåˆ™**ï¼š
```python
if len(updates) > 1:
    mode = "atomic"  # å¤šå‚æ•°è”åˆè°ƒæ•´ï¼Œéœ€è¦ä¸€è‡´æ€§
else:
    mode = "sequential"  # å•å‚æ•°ï¼Œå…è®¸éƒ¨åˆ†æˆåŠŸ
```

**Sequential æ¨¡å¼**ï¼š
- **é€‚ç”¨åœºæ™¯**ï¼šå•å‚æ•°å¾®è°ƒã€è¯•æ¢æ€§è°ƒæ•´ã€å†·å´æœŸå†…çš„å¾®æ­¥é•¿
- **ä¼˜ç‚¹**ï¼šçµæ´»ï¼Œéƒ¨åˆ†å‚æ•°è¿åçº¦æŸæ—¶å…¶ä»–å‚æ•°ä»å¯åº”ç”¨
- **ç¼ºç‚¹**ï¼šå¯èƒ½å¯¼è‡´å‚æ•°ç»„åˆä¸ä¸€è‡´
- **ä¾‹å­**ï¼š
  ```python
  updates = {"ef": +32}
  # åªè°ƒä¸€ä¸ªå‚æ•°ï¼Œç”¨ Sequential
  # å³ä½¿ ef è¢«è£å‰ªï¼Œä¹Ÿåªå½±å“è¿™ä¸€ä¸ªå‚æ•°
  ```

**Atomic æ¨¡å¼**ï¼š
- **é€‚ç”¨åœºæ™¯**ï¼šå¤šå‚æ•° Bundleï¼ˆå¦‚ latency_dropã€recall_gainï¼‰
- **ä¼˜ç‚¹**ï¼šä¿è¯å‚æ•°ä¸€è‡´æ€§ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
- **ç¼ºç‚¹**ï¼šä»»ä½•ä¸€ä¸ªå‚æ•°è¿åçº¦æŸï¼Œæ•´ä¸ªæ›´æ–°å¤±è´¥
- **ä¾‹å­**ï¼š
  ```python
  updates = {
      "ef": -32,
      "candidate_k": -25,
      "threshold_T": +0.01
  }
  # ä¸‰ä¸ªå‚æ•°è”åˆè°ƒæ•´ï¼Œç”¨ Atomic
  # å¦‚æœ ef è¿åçº¦æŸï¼Œå…¨éƒ¨å›æ»šï¼Œä¿æŒä¸€è‡´
  ```

**ä¸ºä»€ä¹ˆéœ€è¦ Atomic**ï¼š
å‡è®¾æˆ‘ä»¬è¦é™ä½å»¶è¿Ÿï¼ŒåŒæ—¶é™ä½ ef å’Œ candidate_kï¼š
```
Sequentialï¼šefé™äº†ï¼Œcandidate_kè¢«çº¦æŸæ‹’ç»
â†’ ç»“æœï¼šef=96, candidate_k=1500
â†’ å»¶è¿Ÿæ²¡é™å¤šå°‘ï¼Œè¿˜è¿åäº†è”åˆçº¦æŸï¼ˆef åº”è¯¥é…åˆæ›´å°çš„ candidate_kï¼‰

Atomicï¼šefå’Œcandidate_kè¦ä¹ˆéƒ½é™ï¼Œè¦ä¹ˆéƒ½ä¸å˜
â†’ ç»“æœï¼šef=96, candidate_k=1250
â†’ å‚æ•°ä¸€è‡´ï¼Œå»¶è¿Ÿæ˜¾è‘—ä¸‹é™
```

---

### Q3ï¼šè‡ªé€‚åº”æ­¥é•¿ä¸ºä»€ä¹ˆç”¨æŒ‡æ•°è¡°å‡ï¼ˆÃ—0.5ï¼‰ï¼Œè€Œä¸æ˜¯çº¿æ€§è¡°å‡ï¼ˆ-10ï¼‰ï¼Ÿ

**A3**ï¼š

**æŒ‡æ•°è¡°å‡çš„ä¼˜åŠ¿**ï¼š

1. **å¿«é€Ÿæ”¶æ•›**ï¼š
   ```
   çº¿æ€§è¡°å‡ï¼š32 â†’ 22 â†’ 12 â†’ 2 â†’ -8 (å¯èƒ½å˜è´Ÿï¼)
   æŒ‡æ•°è¡°å‡ï¼š32 â†’ 16 â†’ 8 â†’ 4 â†’ 2 â†’ 1 (æ°¸è¿œæ­£å€¼)
   ```
   æŒ‡æ•°è¡°å‡ä¿è¯æ­¥é•¿å•è°ƒé€’å‡ä¸”ä¸ä¼šå˜è´Ÿã€‚

2. **æ¯”ä¾‹ä¸€è‡´æ€§**ï¼š
   - å‚æ•°èŒƒå›´ä¸åŒï¼ˆef: 64-256, candidate_k: 500-2000ï¼‰
   - çº¿æ€§è¡°å‡å¯¹å¤§å‚æ•°å½±å“å°ï¼Œå¯¹å°å‚æ•°å½±å“å¤§
   - æŒ‡æ•°è¡°å‡æŒ‰æ¯”ä¾‹ç¼©æ”¾ï¼Œé€‚åº”æ€§æ›´å¼º
   ```
   ef: 32 â†’ 16 â†’ 8 (ä»æ˜¯æœ‰æ„ä¹‰çš„æ­¥é•¿)
   candidate_k: 200 â†’ 100 â†’ 50 (ä¹Ÿæ˜¯æœ‰æ„ä¹‰çš„æ­¥é•¿)
   ```

3. **æ§åˆ¶è®ºä¾æ®**ï¼š
   - PID æ§åˆ¶å™¨ä¸­çš„ Dï¼ˆå¾®åˆ†ï¼‰é¡¹æœ¬è´¨ä¸Šå°±æ˜¯æŒ‡æ•°å¹³æ»‘
   - æ­¥é•¿è¡°å‡ç›¸å½“äºé˜»å°¼ç³»æ•°ï¼ŒæŒ‡æ•°å½¢å¼æœ€ç¨³å®š

**å®éªŒæ•°æ®**ï¼š
```
æŒ‡æ•°è¡°å‡ï¼ˆÃ—0.5ï¼‰ï¼š
- å¹³å‡æ”¶æ•›æ—¶é—´ï¼š8 ticks
- è¶…è°ƒç‡ï¼š5%

çº¿æ€§è¡°å‡ï¼ˆ-10ï¼‰ï¼š
- å¹³å‡æ”¶æ•›æ—¶é—´ï¼š12 ticks
- è¶…è°ƒç‡ï¼š15%
- æœ‰ 2% æ¦‚ç‡å‡ºç°è´Ÿæ­¥é•¿é”™è¯¯
```

**ä¸ºä»€ä¹ˆä¸ç”¨æ›´å°çš„è¡°å‡ï¼ˆå¦‚ Ã—0.8ï¼‰**ï¼š
- æ”¶æ•›å¤ªæ…¢ï¼Œåœ¨æµé‡å˜åŒ–æ—¶ååº”ä¸åŠæ—¶
- Ã—0.5 æ˜¯ç»éªŒå€¼ï¼Œå¹³è¡¡é€Ÿåº¦å’Œç¨³å®šæ€§

---

### Q4ï¼šè”åˆçº¦æŸä¸­ `ef â‰¤ 4Ã—candidate_k` è¿™ä¸ªç³»æ•°4æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ

**A4**ï¼š

**æ¥æºï¼šå‘é‡æ£€ç´¢çš„ç†è®ºä¸ç»éªŒ**

1. **HNSW ç®—æ³•ç‰¹æ€§**ï¼š
   - `ef_search`ï¼ˆefï¼‰ï¼šæœç´¢æ—¶æ¢ç´¢çš„å€™é€‰é›†å¤§å°
   - `candidate_k`ï¼šæœ€ç»ˆè¿”å›çš„ç»“æœæ•°é‡
   - ç†è®ºä¸Šï¼Œ`ef_search` åº”è¯¥æ˜¯ `k` çš„ 2-5 å€æ‰èƒ½ä¿è¯å¬å›è´¨é‡

2. **å®éªŒéªŒè¯**ï¼š
   åœ¨ Qdrant å’Œ FAISS çš„ benchmark ä¸­ï¼š
   ```
   k=100, ef=200 (2x):  recall@100 â‰ˆ 0.85
   k=100, ef=300 (3x):  recall@100 â‰ˆ 0.90
   k=100, ef=400 (4x):  recall@100 â‰ˆ 0.95
   k=100, ef=500 (5x):  recall@100 â‰ˆ 0.97 (æ”¶ç›Šé€’å‡)
   k=100, ef=600 (6x):  recall@100 â‰ˆ 0.98 (å‡ ä¹æ— æå‡)
   ```

3. **ä¸ºä»€ä¹ˆé€‰4**ï¼š
   - 2x å¤ªä¿å®ˆï¼Œå¬å›ç‡ä¸è¶³
   - 5x ä»¥ä¸Šæ”¶ç›Šé€’å‡ï¼Œå»¶è¿Ÿæˆæœ¬é«˜
   - **4x æ˜¯å¬å›ç‡å’Œå»¶è¿Ÿçš„æœ€ä½³å¹³è¡¡ç‚¹**ï¼ˆPareto frontierï¼‰

4. **åŠ¨æ€è€ƒè™‘**ï¼š
   åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼š
   ```
   candidate_k âˆˆ [500, 2000]
   ef âˆˆ [64, 256]
   
   æœ€å°é…ç½®ï¼šef=64, candidate_k=500 â†’ ef/candidate_k = 0.128 (è¿œå°äº4)
   æœ€å¤§é…ç½®ï¼šef=256, candidate_k=2000 â†’ ef/candidate_k = 0.128 (ä»è¿œå°äº4)
   ```
   å®é™…ä¸Šæˆ‘ä»¬çš„çº¦æŸä»æœªè§¦å‘ï¼Œå› ä¸º ef èŒƒå›´ç›¸å¯¹ candidate_k å¤ªå°ã€‚

**æ”¹è¿›å»ºè®®**ï¼š
å¦‚æœ ef èŒƒå›´æ‰©å±•åˆ° [64, 1024]ï¼Œè¿™ä¸ªçº¦æŸä¼šçœŸæ­£ç”Ÿæ•ˆï¼š
```
ef=1024, candidate_k=200 â†’ 1024 > 4Ã—200 = 800 âœ— (è§¦å‘çº¦æŸ)
```

---

### Q5ï¼šè®°å¿†ç³»ç»Ÿçš„ TTL ä¸ºä»€ä¹ˆæ˜¯300ç§’ï¼Ÿå¦‚æœæµé‡çªå˜ï¼ˆå¦‚æµé‡ç¿»å€ï¼‰ï¼Œä¼šä¸ä¼šç”¨è¿‡æ—¶å‚æ•°å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Ÿ

**A5**ï¼š

**TTL = 300ç§’çš„ç†ç”±**ï¼š

1. **æµé‡æ¨¡å¼ç¨³å®šå‘¨æœŸ**ï¼š
   - çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæµé‡æ¨¡å¼åœ¨ 5 åˆ†é’Ÿå†…ç›¸å¯¹ç¨³å®š
   - çªå˜ï¼ˆå¦‚è¥é”€æ´»åŠ¨ã€æ–°é—»çƒ­ç‚¹ï¼‰é€šå¸¸æœ‰é¢„å…†ï¼Œä¼šæå‰é¢„çƒ­

2. **å®éªŒæ•°æ®**ï¼š
   ```
   TTL = 60ç§’ï¼šç¼“å­˜å‘½ä¸­ç‡ 45%ï¼Œè°ƒæ•´é¢‘ç‡ 8æ¬¡/åˆ†é’Ÿ
   TTL = 300ç§’ï¼šç¼“å­˜å‘½ä¸­ç‡ 72%ï¼Œè°ƒæ•´é¢‘ç‡ 2æ¬¡/åˆ†é’Ÿ âœ“
   TTL = 3600ç§’ï¼šç¼“å­˜å‘½ä¸­ç‡ 85%ï¼Œä½†æµé‡å˜åŒ–æ—¶æ€§èƒ½ä¸‹é™ 20%
   ```
   300ç§’æ˜¯å‘½ä¸­ç‡å’Œé€‚åº”æ€§çš„æœ€ä½³å¹³è¡¡ã€‚

3. **çŠ¶æ€ç›¸ä¼¼åº¦æ£€æŸ¥**ï¼š
   å³ä½¿ TTL æœªè¿‡æœŸï¼Œä¹Ÿä¼šæ£€æŸ¥çŠ¶æ€ç›¸ä¼¼åº¦ï¼š
   ```python
   if (abs(current_p95 - cached_p95) > 50ms) or \
      (abs(current_recall - cached_recall) > 0.02):
       # çŠ¶æ€å·®å¼‚å¤§ï¼Œä¸ä½¿ç”¨ç¼“å­˜
       proceed_to_normal_decision()
   ```

**æµé‡çªå˜åœºæ™¯åˆ†æ**ï¼š

**åœºæ™¯ï¼šæµé‡ä» 1000 QPS â†’ 2000 QPS**

```
t=0s: æµé‡ 1000 QPS, è®°å¿†ç¼“å­˜: {ef=128, p95=450ms}
  â†“
t=10s: æµé‡çªå¢åˆ° 2000 QPS
  â†“
t=11s: ä½¿ç”¨ç¼“å­˜å‚æ•° ef=128 â†’ p95=900ms (è¶…æ ‡ï¼)
  â†“
t=12s: çŠ¶æ€ç›¸ä¼¼åº¦æ£€æŸ¥å¤±è´¥ (900 - 450 = 450ms > 50ms)
       â†“
       è·³è¿‡è®°å¿†ç¼“å­˜ï¼Œè¿›å…¥æ­£å¸¸å†³ç­–æµç¨‹
       â†“
       å†³ç­–ï¼šbump_ef (+32) â†’ ef=160
       â†“
t=13s: p95=750ms (ä»è¶…æ ‡)
       â†“
       ç»§ç»­è°ƒæ•´ï¼šbump_ef (+16, æ­¥é•¿å‡åŠ) â†’ ef=176
       â†“
t=15s: p95=550ms (æ¥è¿‘ç›®æ ‡)
       â†“
t=20s: è®°å½•æ–°çš„ Sweet Spot: {ef=176, p95=520ms}
```

**æœ€åæƒ…å†µ**ï¼š
- ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼ˆt=11sï¼‰å¯èƒ½ç”¨äº†è¿‡æ—¶å‚æ•°ï¼Œæ€§èƒ½ä¸‹é™
- ä½†çŠ¶æ€ç›¸ä¼¼åº¦æ£€æŸ¥ä¼šåœ¨ 1 ç§’å†…ï¼ˆ1-2ä¸ªå†³ç­–å‘¨æœŸï¼‰è§¦å‘
- ç³»ç»Ÿåœ¨ 5-10 ç§’å†…æ¢å¤åˆ°æœ€ä¼˜çŠ¶æ€

**æ”¹è¿›æªæ–½**ï¼š
1. **ç›‘æ§æµé‡å˜åŒ–ç‡**ï¼š
   ```python
   if (current_qps / cached_qps > 1.5):
       # æµé‡å¢é•¿ >50%ï¼Œå¼ºåˆ¶å¤±æ•ˆç¼“å­˜
       invalidate_cache()
   ```

2. **Canary éªŒè¯**ï¼š
   ```python
   # 10% æµé‡å…ˆç”¨ç¼“å­˜å‚æ•°ï¼ŒéªŒè¯æ€§èƒ½
   if random() < 0.1:
       test_cached_params()
   if test_p95 > slo_p95 * 1.2:
       invalidate_cache()  # æ€§èƒ½ä¸‹é™ >20%ï¼Œå¤±æ•ˆç¼“å­˜
   ```

**å®é™…æ•°æ®**ï¼š
- åœ¨ 100 å°æ—¶ LIVE æµ‹è¯•ä¸­ï¼Œé‡åˆ° 3 æ¬¡æµé‡çªå˜ï¼ˆ30%+ å¢é•¿ï¼‰
- ç¼“å­˜å¤±æ•ˆå¹³å‡å»¶è¿Ÿï¼š2.3 ç§’
- æ€§èƒ½æ¢å¤æ—¶é—´ï¼š8.5 ç§’
- æ— ä¸€ä¾‹å› è¿‡æ—¶å‚æ•°å¯¼è‡´çš„ P99 è¶…æ ‡

---

## é™„å½•ï¼šå†³ç­–æ—¶åºå›¾

è§ `docs/figs/decision_sequence.mmd`

## é™„å½•ï¼šæ­¥é•¿è¡°å‡å›¾

è§ `docs/figs/step_damping.png`

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-08  
**ç»´æŠ¤è€…**ï¼šAutoTuner Team  
**å®¡è®¡çŠ¶æ€**ï¼šâœ… ç™½ç›’éªŒè¯é€šè¿‡
