# ⚙️ 灰度模拟验证（10%流量，约10–20分钟）

## 概述

本测试脚本实现了真实的灰度部署验证，模拟 10% 流量启用 RAG QueryRewriter + AsyncCache 的场景。

## 配置参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **流量分配** | 10% ON / 90% OFF | 灰度流量分配 |
| **测试时长** | 600s (~10分钟) | 60s ON + 540s OFF |
| **QPS** | 12 | 目标查询吞吐量 |
| **Bucket** | 10秒 | P95延迟计算分桶 |
| **Async** | ✅ Enabled | 异步改写 |
| **Cache** | ✅ Enabled | 查询缓存 |

## 运行方式

```bash
# 从项目根目录执行
./run_canary_90_10.sh
```

## 输出文件

1. **HTML报告**: `reports/rag_rewrite_ab.html`
   - 包含完整的可视化分析
   - 中文标题: "⚙️ 灰度模拟验证（10%流量，约10–20分钟）"
   - 核心指标展示（Recall Delta, P95 Delta, Cache Hit Rate）

2. **JSON数据**: `reports/rag_rewrite_ab.json`
   - 结构化数据，便于后续分析
   - 包含 test_type: "canary_10_pct"

3. **运行日志**: `logs/canary_10pct_run.log`
   - 完整的终端输出
   - 包含实时进度和最终总结

## 生产门禁

测试会自动检查以下 5 个门禁：

| 门禁 | 阈值 | 说明 |
|------|------|------|
| **ΔRecall** | ≥ +5% | Recall@10 提升 |
| **p-value** | < 0.05 | 统计显著性 |
| **ΔP95** | ≤ +5ms | P95延迟增幅 |
| **失败率** | < 1% | 改写失败率 |
| **成本** | ≤ $0.00005/query | 每查询成本 |

## 终端输出示例

```
╔══════════════════════════════════════════════════════════════╗
║  ⚙️ 灰度模拟验证（10%流量，约10–20分钟）                       ║
╚══════════════════════════════════════════════════════════════╝

Configuration:
  Rewrite OFF: 90% traffic
  Rewrite ON:  10% traffic (canary)
  Duration: 10-20 minutes (600-1200s)
  QPS: 12
  Buckets: 10s
  Async: Enabled
  Cache: Enabled

================================================================================
🎯 灰度测试总结 (10% 流量)
================================================================================

【核心指标】
  ΔRecall@10: +4.2% (绝对值: +0.0420)
  ΔP95 延迟: +2.3ms
  Cache Hit: 94.5%
  Async Hit: 67.8%
  失败率: 0.12%

【生产门禁检查】
  ✓ ΔRecall≥5% (0.0420)
  ✓ p<0.05 (0.0023)
  ✓ ΔP95≤5ms (2.3ms)
  ✓ 失败率<1% (0.12%)
  ✓ 成本≤$0.00005 ($0.000042)

【附加指标】
  Cache Hit Rate: 94.5% (✓ >90%)
  Async Hit Rate: 67.8%
  每查询成本: $0.000042
  平均 Tokens In: 175.3
  平均 Tokens Out: 48.2

================================================================================
✅ PASS - 所有门禁通过 + 缓存健康
   ΔRecall=+4.2%, ΔP95=+2.3ms, p=0.0023
   cost=$0.000042, fail=0.12%, cache_hit=94.5%
   🎯 建议: 扩大至 50% 流量继续验证
================================================================================
```

## 判定标准

### ✅ PASS
- 所有 5 个门禁全部通过
- Cache Hit Rate > 90%
- **建议**: 扩大至 50% 流量继续验证（运行 `./run_canary_50_50.sh`）

### ⚠️ WARN
- 门禁通过，但 Cache Hit Rate < 90%
- **建议**: 检查缓存配置，延长观察时间

### ❌ FAIL
- 任一门禁未通过
- **建议**: 回滚或优化后重新测试

## 预期结果

在正常情况下，测试应该显示：

1. **Recall 提升**: +4~6% (绝对值 0.04~0.06)
2. **延迟影响**: P95 增加 < 5ms (由于 async 优化)
3. **缓存效率**: Hit Rate > 90%
4. **稳定性**: 失败率 < 1%
5. **成本控制**: < $0.00005/query

## 故障排查

### 问题: Cache Hit Rate 偏低 (< 90%)

**原因**:
- 测试时长不足，缓存未充分预热
- 查询重复度低

**解决**:
- 延长测试时长至 20 分钟（修改脚本中 `duration_per_side_sec = 1200`）
- 检查查询分布

### 问题: 失败率过高 (> 1%)

**原因**:
- 模拟的 LLM 调用超时
- 网络不稳定

**解决**:
- 检查 MockProvider 配置
- 调整重试策略

### 问题: P95 延迟增幅过大 (> 5ms)

**原因**:
- Async 命中率低
- 缓存未生效

**解决**:
- 检查 async_rewrite 配置
- 验证缓存 TTL 设置

## 下一步

如果测试通过：

1. **扩大流量**: 运行 50/50 测试
   ```bash
   ./run_canary_50_50.sh
   ```

2. **完整验证**: 运行 30 分钟完整测试
   ```bash
   ./run_live_full_10min.sh
   ```

3. **生产部署**: 遵循灰度发布流程
   - 10% → 50% → 100%
   - 每阶段观察指标稳定后再扩大

## 技术细节

### 测试流程

```
1. Phase 1: 运行 ON 组 (60s @ 12 QPS)
   - 启用 rewrite=True, async=True, cache=True
   - 收集指标: recall, latency, tokens, failures

2. Phase 2: 运行 OFF 组 (540s @ 12 QPS)
   - 禁用 rewrite=False
   - 作为基线对照

3. 统计分析:
   - Permutation Test (5000 trials)
   - P95 分桶计算 (10s bucket)
   - 成本计算 (OpenAI gpt-4o-mini pricing)

4. 生成报告:
   - HTML 可视化报告
   - JSON 结构化数据
   - 终端中文总结
```

### 关键优化

1. **异步改写**: 
   - 改写请求不阻塞搜索
   - 命中率 ~60-70%
   
2. **查询缓存**:
   - TTL: 600s
   - 精确匹配 + 归一化
   - 命中率 > 90%

3. **失败重试**:
   - 自动重试 1 次
   - 重试成功率 ~70%

## 联系方式

如有问题，请参考：
- `RAG_REWRITER_AB_TEST_README.md` - AB测试详细文档
- `CANARY_DEPLOYMENT_SYSTEM.md` - 灰度发布系统文档
- `PRODUCTION_GATE_SUMMARY.md` - 生产门禁标准

