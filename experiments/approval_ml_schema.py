"""
approval_ml_schema.py - Training Data Schema for ML-Based ApprovalScore

This module defines the TrainingSample schema for distilling the existing
rule-based approval decision logic into an ML model.

IMPORTANT NOTES:
- This schema is for DISTILLING the existing approval rules into an ML model.
- We are NOT using real production loan history - this is synthetic data
  generated by calling the existing rule-based run_stress_check function.
- DO NOT include stress_band, existing approval_score numeric value, or
  risk_flags as features - these are derived labels and would cause label leakage.
- Only include primitive borrower/home features and simple ratios.
"""

from dataclasses import dataclass
from typing import Literal


@dataclass
class TrainingSample:
    """
    Training sample for ML-based ApprovalScore model.
    
    This schema contains ONLY primitive features and simple ratios that can be
    computed from borrower and property inputs. It does NOT include any derived
    labels like stress_band, approval_score, or risk_flags to avoid label leakage.
    
    The labels (teacher_bucket and teacher_approve_label) come from the existing
    rule-based ApprovalScore computation, which acts as the "teacher" in this
    distillation setup.
    """
    
    # ========================================================================
    # Primitive Borrower Features
    # ========================================================================
    income_monthly: float
    """Monthly income in dollars."""
    
    other_debt_monthly: float
    """Other monthly debt payments in dollars."""
    
    # ========================================================================
    # Primitive Property Features
    # ========================================================================
    home_price: float
    """Home listing price in dollars."""
    
    down_payment_pct: float
    """Down payment percentage (0-1), e.g., 0.20 for 20%."""
    
    # ========================================================================
    # Loan Terms
    # ========================================================================
    interest_rate: float
    """Annual interest rate (as decimal, e.g., 0.06 for 6%)."""
    
    loan_term_years: int
    """Loan term in years (typically 30)."""
    
    # ========================================================================
    # Location Features
    # ========================================================================
    state: str
    """State code (e.g., 'CA', 'TX')."""
    
    zip_code: str
    """ZIP code (e.g., '90210')."""
    
    # ========================================================================
    # Derived Ratios (computed from primitives, not labels)
    # ========================================================================
    ltv: float
    """Loan-to-value ratio (0-1), computed as loan_amount / home_price."""
    
    dti: float
    """Debt-to-income ratio (0-1), computed from total monthly payment and income."""
    
    payment_to_income: float
    """Total monthly payment / monthly income ratio."""
    
    cash_buffer_ratio: float
    """Cash buffer ratio: (income - total_payment - other_debt) / total_payment.
    
    This represents how much "buffer" the borrower has after all payments.
    Higher values indicate more financial cushion.
    """
    
    # ========================================================================
    # Teacher Labels (from existing rule-based logic)
    # ========================================================================
    teacher_bucket: Literal["likely", "borderline", "unlikely"]
    """Approval bucket from existing rule-based ApprovalScore.bucket."""
    
    teacher_approve_label: int
    """Binary approval label: 1 if teacher_bucket == 'likely', else 0.
    
    This is used for simple binary classification training.
    """
