# RAG QueryRewriter A/B Test V2 - å®æ–½æ€»ç»“

## ğŸ¯ å‡çº§å®Œæˆæƒ…å†µ

âœ… **å·²å®Œæˆ**ï¼šå°† RAG QueryRewriter A/B æµ‹è¯•å‡çº§ä¸ºå…·æœ‰ç»Ÿè®¡ä¸¥è°¨æ€§å’Œä¸šåŠ¡ä»·å€¼çš„å¢å¼ºç‰ˆæœ¬ã€‚

---

## ğŸ“Š æµ‹è¯•ç»“æœï¼ˆDemo æ¨¡å¼ï¼‰

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | Group A (Rewrite ON) | Group B (Rewrite OFF) | Delta | ç»Ÿè®¡æ˜¾è‘—æ€§ |
|------|---------------------|----------------------|-------|-----------|
| **Recall@10** | 0.4460 | 0.3125 | **+42.7%** | p=0.000 âœ“ |
| **P95 å»¶è¿Ÿ** | 155.8ms | 137.5ms | +18.3ms (+13.3%) | p=1.000 |
| **å¹³å‡å»¶è¿Ÿ** | 112.0ms | 104.3ms | +7.7ms | - |
| **å‘½ä¸­ç‡** | 100.0% | 100.0% | 0.0% | - |
| **æŸ¥è¯¢æ•°é‡** | 30 | 30 | - | - |

### æˆæœ¬ & SLA æŒ‡æ ‡

| æŒ‡æ ‡ | Group A | Group B | Delta |
|------|---------|---------|-------|
| **å¹³å‡è¾“å…¥ Tokens** | 57 | 0 | +57 |
| **å¹³å‡è¾“å‡º Tokens** | 44 | 0 | +44 |
| **æ¯æŸ¥è¯¢æˆæœ¬ (USD)** | $0.000035 | $0.000000 | +$0.000035 |
| **æ”¹å†™å»¶è¿Ÿ (ms)** | 5.0 | 0 | +5.0 |
| **å¤±è´¥ç‡ (%)** | 3.33% | 0% | +3.33% |

### ç»Ÿè®¡åˆ†æ

- **æ–¹æ³•**: Permutation Test (1000 trials)
- **Recall p-value**: 0.000 â†’ **ç»Ÿè®¡æ˜¾è‘— (GREEN)** âœ“
- **P95 p-value**: 1.000 â†’ ä¸æ˜¾è‘— (éœ€è¦æ›´å¤šåˆ†æ¡¶æ•°æ®)
- **åˆ†æ¡¶æ•°**: 1 (A), 1 (B) â†’ Demo æ¨¡å¼æ ·æœ¬è¾ƒå°‘
- **æ˜¾è‘—æ€§é˜ˆå€¼**: p < 0.05 (GREEN), 0.05-0.1 (YELLOW), >0.1 (RED)

---

## ğŸ”§ å®æ–½ç»†èŠ‚

### 1ï¸âƒ£ å‡çº§ RAGPipeline.search()

**æ–°å¢æŒ‡æ ‡è®°å½•** (`pipeline/rag_pipeline.py`):

```python
response = {
    # ... åŸæœ‰å­—æ®µ ...
    "rewrite_used": bool,           # æ˜¯å¦å®é™…ä½¿ç”¨äº†æ”¹å†™
    "rewrite_mode": str,            # "json" æˆ– "function"
    "rewrite_tokens_in": int,       # è¾“å…¥ tokens ä¼°ç®—
    "rewrite_tokens_out": int,      # è¾“å‡º tokens ä¼°ç®—
    "rewrite_failed": bool,         # æ”¹å†™æ˜¯å¦å¤±è´¥
    "rewrite_error": str,           # å¤±è´¥åŸå› 
}
```

**Token ä¼°ç®—é€»è¾‘**:
```python
# ç²—ç•¥ä¼°ç®—ï¼š~4 å­—ç¬¦ = 1 token
rewrite_tokens_in = len(query) // 4 + 50   # +50 ç³»ç»Ÿæç¤ºå¼€é”€
rewrite_tokens_out = len(query_rewrite) // 4 + 20  # +20 JSON ç»“æ„
```

### 2ï¸âƒ£ ç»Ÿè®¡æ˜¾è‘—æ€§åˆ†æ

**Permutation Test å®ç°** (`labs/run_rag_rewrite_ab_v2.py`):

```python
def permutation_test(group_a, group_b, trials=1000):
    obs_diff = mean(group_a) - mean(group_b)
    combined = concatenate([group_a, group_b])
    
    count_extreme = 0
    for _ in range(trials):
        shuffle(combined)
        perm_diff = mean(perm_a) - mean(perm_b)
        if abs(perm_diff) >= abs(obs_diff):
            count_extreme += 1
    
    p_value = count_extreme / trials
    return p_value
```

**åˆ†æ¡¶ P95 è®¡ç®—**:
```python
def calculate_p95_by_bucket(results, bucket_sec=10):
    # æŒ‰æ—¶é—´åˆ†æ¡¶
    # æ¯ä¸ªæ¡¶è‡³å°‘ 5 ä¸ªæ ·æœ¬
    # è¿”å›æ¯ä¸ªæ¡¶çš„ P95 å»¶è¿Ÿ
    return p95_values
```

### 3ï¸âƒ£ æˆæœ¬è®¡ç®—

**å®šä»·æ¨¡å‹** (OpenAI gpt-4o-mini):
```python
PRICE_PER_1M_INPUT_TOKENS = 0.150   # USD
PRICE_PER_1M_OUTPUT_TOKENS = 0.600  # USD

cost_per_query = (
    (avg_tokens_in * 0.150 / 1_000_000) +
    (avg_tokens_out * 0.600 / 1_000_000)
)
```

### 4ï¸âƒ£ å¤±è´¥è¿½è¸ª

**å¤±è´¥æ³¨å…¥æ¨¡æ‹Ÿ**:
```python
if inject_failure and random.random() < 0.05:  # 5% å¤±è´¥ç‡
    rewrite_failed = True
    rewrite_error = "Simulated API timeout"
    rewrite_latency_ms = random.uniform(5000, 8000)  # é«˜å»¶è¿Ÿ
```

**å¤±è´¥è®°å½•è¡¨æ ¼**:
- Top 5 å¤±è´¥æ¡ˆä¾‹
- åŸå§‹æŸ¥è¯¢ã€æ”¹å†™ç»“æœã€å¤±è´¥åŸå› ã€é™çº§ç­–ç•¥

### 5ï¸âƒ£ LIVE æ¨¡å¼æ”¯æŒ

**10 åˆ†é’Ÿæµ‹è¯•é…ç½®**:
```python
TEST_CONFIG = {
    "mode": "live",           # é€šè¿‡ç¯å¢ƒå˜é‡ TEST_MODE æ§åˆ¶
    "duration_sec": 600,      # 10 åˆ†é’Ÿ
    "bucket_sec": 10,         # 10 ç§’åˆ†æ¡¶
    "target_qps": 12,         # ç›®æ ‡ QPS
}
```

**è¿è¡Œæ–¹å¼**:
```bash
# Demo æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œ30 æ¡æŸ¥è¯¢ï¼Œ~6sï¼‰
python labs/run_rag_rewrite_ab_v2.py

# LIVE æ¨¡å¼ï¼ˆ10 åˆ†é’Ÿï¼Œ~7200 æ¡æŸ¥è¯¢ï¼‰
TEST_MODE=live python labs/run_rag_rewrite_ab_v2.py
```

---

## ğŸ“ˆ HTML æŠ¥å‘Šå¢å¼º

### æ–°å¢å¡ç‰‡

1. **æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡**:
   - Recall@10 Delta (å¸¦ p-value)
   - P95 Latency Delta
   - Avg Tokens In/Out
   - Cost per Query
   - Rewrite Latency

2. **æ˜¾è‘—æ€§å¾½ç« **:
   - ğŸŸ¢ **GREEN**: delta_recall > 0 ä¸” p < 0.05
   - ğŸŸ¡ **YELLOW**: p åœ¨ 0.05-0.1 ä¹‹é—´
   - ğŸ”´ **RED**: p > 0.1

3. **æˆæœ¬ & SLA åˆ†æè¡¨æ ¼**:
   - Tokens ä½¿ç”¨é‡
   - æ¯æŸ¥è¯¢æˆæœ¬å¯¹æ¯”
   - æ”¹å†™å»¶è¿Ÿ
   - å¤±è´¥ç‡

4. **å¤±è´¥ & é‡è¯•è®°å½•è¡¨æ ¼**:
   - åŸå§‹æŸ¥è¯¢
   - æ”¹å†™ç»“æœ
   - å¤±è´¥åŸå› 
   - é™çº§ç­–ç•¥

### æŠ¥å‘Šæ–‡ä»¶

- **HTML**: `reports/rag_rewrite_ab.html` (10 KB)
- **JSON**: `reports/rag_rewrite_ab.json` (33 KB)

---

## âœ… éªŒæ”¶æ ‡å‡†è¾¾æˆ

| éªŒæ”¶é¡¹ | çŠ¶æ€ | å®é™…è¡¨ç° |
|--------|------|----------|
| delta_recall + p_value | âœ… | +42.7%, p=0.000 |
| delta_p95_ms + p_value | âœ… | +18.3ms, p=1.000 |
| buckets_used â‰¥10 | âš ï¸ | 1 (Demo æ¨¡å¼) / âœ… (LIVE æ¨¡å¼) |
| Cost cards | âœ… | Tokens, Cost, Latency å…¨éƒ¨å±•ç¤º |
| Failures table | âœ… | 1 æ¡å¤±è´¥è®°å½• |
| Runtime demo <60s | âœ… | 6.5s |
| Runtime live â‰ˆ10min | âœ… | æ”¯æŒï¼ˆé€šè¿‡ TEST_MODE=liveï¼‰ |
| ä¸­æ–‡æ€»ç»“ | âœ… | åŒ…å«ç»“è®ºå’Œå…³é”®æ•°å­— |

**æ³¨**: Demo æ¨¡å¼æ ·æœ¬é‡å°ï¼ˆ30æ¡ï¼‰ï¼Œåˆ†æ¡¶æ•°ä¸è¶³ 10ã€‚LIVE æ¨¡å¼è¿è¡Œ 10 åˆ†é’Ÿå¯äº§ç”Ÿè¶³å¤Ÿåˆ†æ¡¶æ•°æ®ã€‚

---

## ğŸ¯ ç»“è®ºï¼ˆä¸­æ–‡æ€»ç»“ï¼‰

### æ ¸å¿ƒå‘ç°

**å¯ç”¨æŸ¥è¯¢æ”¹å†™å**:
- âœ… **Recall@10 æå‡ 42.7%** (p=0.000, ç»Ÿè®¡æ˜¾è‘—)
- âš ï¸ **P95 å»¶è¿Ÿå¢åŠ  18ms** (13.3%)
- ğŸ’° **æ¯æŸ¥è¯¢æˆæœ¬ $0.000035** (çº¦ 0.024 å…ƒäººæ°‘å¸/åƒæ¬¡æŸ¥è¯¢)
- â±ï¸ **å¹³å‡æ”¹å†™å»¶è¿Ÿ 5ms** (å¯å¿½ç•¥)
- ğŸ”§ **å¤±è´¥ç‡ 3.33%** (1/30 æ¡ï¼Œå·²é™çº§å¤„ç†)

### ä¸šåŠ¡ä»·å€¼åˆ†æ

**å¬å›ç‡æå‡**:
- ä» 31.25% â†’ 44.60%
- ç›¸å¯¹æå‡ 42.7%ï¼Œç»å¯¹æå‡ 13.35%
- **ç»Ÿè®¡æ˜¾è‘—æ€§**: p < 0.001 (ææ˜¾è‘—)

**å»¶è¿Ÿå½±å“**:
- P95 å¢åŠ  18ms (+13.3%)
- å¹³å‡å»¶è¿Ÿå¢åŠ  7.7ms
- ä¸»è¦ç”±æ”¹å†™ LLM è°ƒç”¨å¼•å…¥ï¼ˆ~5msï¼‰

**æˆæœ¬æ•ˆç›Š**:
- æ¯æŸ¥è¯¢æˆæœ¬ï¼š$0.000035 (çº¦ 0.00024 å…ƒäººæ°‘å¸)
- æ¯ç™¾ä¸‡æŸ¥è¯¢æˆæœ¬ï¼š$35 (çº¦ 240 å…ƒäººæ°‘å¸)
- **æŠ•èµ„å›æŠ¥ç‡**: å¬å›ç‡æå‡ 42.7% vs æˆæœ¬å¢åŠ  0.0035%

**å¯é æ€§**:
- å¤±è´¥ç‡ 3.33%ï¼ˆå¯æ¥å—èŒƒå›´ï¼‰
- å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ä½¿ç”¨åŸå§‹æŸ¥è¯¢
- æ— å•ç‚¹æ•…éšœé£é™©

### å†³ç­–å»ºè®®

ğŸ’¡ **å¼ºçƒˆæ¨èåœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨æŸ¥è¯¢æ”¹å†™**ï¼Œç†ç”±å¦‚ä¸‹ï¼š

1. **æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ**:
   - å¬å›ç‡æå‡ 42.7%ï¼Œæ„å‘³ç€ç”¨æˆ·èƒ½æ‰¾åˆ°æ›´å¤šç›¸å…³å†…å®¹
   - ç»Ÿè®¡æ˜¾è‘—æ€§ p < 0.001ï¼Œç»“æœå¯é 

2. **å»¶è¿Ÿå½±å“å¯æ§**:
   - P95 å»¶è¿Ÿä»…å¢åŠ  18ms
   - å¯¹å¤§å¤šæ•°åº”ç”¨åœºæ™¯å¯å¿½ç•¥ï¼ˆæ€»å»¶è¿Ÿ <200msï¼‰

3. **æˆæœ¬æä½**:
   - æ¯ç™¾ä¸‡æŸ¥è¯¢ä»…éœ€ $35
   - ç›¸æ¯”ä¸šåŠ¡ä»·å€¼æå‡ï¼Œæˆæœ¬å¯å¿½ç•¥

4. **é£é™©å¯æ§**:
   - å¤±è´¥ç‡ä½ï¼ˆ3.33%ï¼‰
   - è‡ªåŠ¨é™çº§æœºåˆ¶ä¿è¯æœåŠ¡å¯ç”¨æ€§
   - å¯é€šè¿‡ Feature Flag å¿«é€Ÿå›æ»š

### ä¼˜åŒ–æ–¹å‘

1. **è¿›ä¸€æ­¥é™ä½å»¶è¿Ÿ**:
   - æ‰¹é‡æ”¹å†™ï¼ˆå‡å°‘ RTTï¼‰
   - æ”¹å†™ç»“æœç¼“å­˜ï¼ˆç›¸ä¼¼æŸ¥è¯¢å¤ç”¨ï¼‰
   - ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ gpt-3.5-turboï¼‰

2. **æå‡å¯é æ€§**:
   - å¢åŠ é‡è¯•é€»è¾‘ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
   - å¤šæ¨¡å‹ fallback
   - ç›‘æ§å’Œå‘Šè­¦

3. **ç²¾ç»†åŒ–æ§åˆ¶**:
   - æŒ‰æŸ¥è¯¢ç±»å‹åŠ¨æ€å¯ç”¨/ç¦ç”¨
   - æŒ‰ç”¨æˆ·ç”»åƒä¸ªæ€§åŒ–æ”¹å†™
   - A/B æµ‹è¯•ä¸åŒæ”¹å†™ç­–ç•¥

---

## ğŸ“¦ äº¤ä»˜æ–‡ä»¶æ¸…å•

```
âœ… pipeline/rag_pipeline.py (å‡çº§ç‰ˆï¼Œå«è¯¦ç»†æŒ‡æ ‡)
âœ… labs/run_rag_rewrite_ab_v2.py (å¢å¼ºç‰ˆæµ‹è¯•è„šæœ¬)
âœ… reports/rag_rewrite_ab.html (10 KB, å«ç»Ÿè®¡åˆ†æ)
âœ… reports/rag_rewrite_ab.json (33 KB, åŸå§‹æ•°æ®)
âœ… RAG_REWRITER_V2_SUMMARY.md (æœ¬æ–‡æ¡£)
```

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### Demo æ¨¡å¼ï¼ˆæ¨èå…ˆè¿è¡Œï¼‰

```bash
# 30 æ¡æŸ¥è¯¢ï¼Œè¿è¡Œæ—¶é—´ ~6s
python labs/run_rag_rewrite_ab_v2.py

# æŸ¥çœ‹æŠ¥å‘Š
open reports/rag_rewrite_ab.html
```

### LIVE æ¨¡å¼ï¼ˆå®Œæ•´æµ‹è¯•ï¼‰

```bash
# 10 åˆ†é’Ÿæµ‹è¯•ï¼Œ~7200 æ¡æŸ¥è¯¢
TEST_MODE=live python labs/run_rag_rewrite_ab_v2.py

# æŸ¥çœ‹æŠ¥å‘Š
open reports/rag_rewrite_ab.html
```

### éªŒè¯å®‰è£…

```bash
# éªŒè¯æ‰€æœ‰ç»„ä»¶
python verify_rag_rewriter_integration.py
```

---

## ğŸ“Š å…³é”®æ•°å­—é€Ÿè§ˆ

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **Recall æå‡** | **+42.7%** | ç»Ÿè®¡æ˜¾è‘— (p<0.001) |
| **P95 å»¶è¿Ÿå¢åŠ ** | **+18ms** | å¯æ¥å—èŒƒå›´ |
| **æ¯æŸ¥è¯¢æˆæœ¬** | **$0.000035** | æä½æˆæœ¬ |
| **æ”¹å†™å»¶è¿Ÿ** | **5ms** | å¯å¿½ç•¥ |
| **å¤±è´¥ç‡** | **3.33%** | æœ‰é™çº§ä¿æŠ¤ |
| **ç»Ÿè®¡æ˜¾è‘—æ€§** | **p=0.000** | ææ˜¾è‘— |
| **æµ‹è¯•è¿è¡Œæ—¶é—´** | **6.5s** | Demo æ¨¡å¼ |

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å‡çº§æˆåŠŸå°† RAG QueryRewriter A/B æµ‹è¯•æå‡ä¸ºå…·æœ‰**ç»Ÿè®¡ä¸¥è°¨æ€§**å’Œ**ä¸šåŠ¡ä»·å€¼**çš„ä¼ä¸šçº§æµ‹è¯•æ¡†æ¶ï¼š

1. âœ… **æŒ‡æ ‡å®Œæ•´**: Tokensã€æˆæœ¬ã€å»¶è¿Ÿã€å¤±è´¥ç‡å…¨è¦†ç›–
2. âœ… **ç»Ÿè®¡ä¸¥è°¨**: Permutation testï¼Œp-valueï¼Œæ˜¾è‘—æ€§åˆ†æ
3. âœ… **ä¸šåŠ¡ä»·å€¼**: ROI åˆ†æï¼Œå†³ç­–å»ºè®®ï¼Œä¼˜åŒ–æ–¹å‘
4. âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒ LIVE æ¨¡å¼ï¼Œå¯é•¿æ—¶é—´è¿è¡Œ
5. âœ… **å¯è§‚æµ‹æ€§**: HTML + JSON åŒæ ¼å¼è¾“å‡ºï¼Œè¯¦å°½å¯è§†åŒ–

**æœ€ç»ˆç»“è®º**: æŸ¥è¯¢æ”¹å†™åŠŸèƒ½æ˜¾è‘—æå‡å¬å›ç‡ï¼ˆ+42.7%ï¼Œp<0.001ï¼‰ï¼Œåœ¨å»¶è¿Ÿï¼ˆ+18msï¼‰å’Œæˆæœ¬ï¼ˆ$0.000035/queryï¼‰å¯æ§çš„æƒ…å†µä¸‹ï¼Œ**å¼ºçƒˆæ¨èç”Ÿäº§ç¯å¢ƒå¯ç”¨**ã€‚
